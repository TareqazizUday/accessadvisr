{% load static %}
<section class="hero-map-section position-relative" id="heroMapSection">
    <!-- Google Maps will be initialized here -->
    <div id="homeMap" style="width: 100%; height: 500px; position: relative;"></div>

    <div class="container search-container">
        <div class="row justify-content-center">
            <div class="col-lg-11">
                <div class="search-bar-wrapper bg-white shadow-lg rounded-1">
                    <form class="row g-0 align-items-center" action="{% url 'search_results' %}" method="get">
                        
                        <div class="col-md-3 border-end-custom">
                            <div class="d-flex align-items-center px-3 py-2">
                                <i class="bi bi-pencil-square text-muted"></i>
                                <input type="text" name="keywords" class="form-control border-0 shadow-none bg-transparent" placeholder="Keywords...">
                            </div>
                        </div>

                        <div class="col-md-3 border-end-custom">
                            <div class="d-flex align-items-center px-3 py-2">
                                <i class="bi bi-layers text-muted"></i>
                                <select name="category" class="form-select border-0 shadow-none bg-transparent">
                                    <option selected disabled>Filter by category</option>
                                    <option value="accommodation">Accommodation</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="food">Food & Drink</option>
                                    <option value="shopping">Shopping</option>
                                    <option value="sport">Sports & Recreational</option>
                                    <option value="transport">Transport</option>
                                    <option value="travel">Flight & Travel</option>
                                    <option value="education">Education</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-3 border-end-custom">
                            <div class="d-flex align-items-center px-3 py-2">
                                <i class="bi bi-geo-alt text-muted"></i>
                                <input type="text" name="location" id="locationInput" class="form-control border-0 shadow-none bg-transparent" placeholder="Location">
                            </div>
                        </div>

                        <div class="col-md-3 p-2">
                            <button type="submit" class="btn btn-orange w-100 py-3 fw-bold text-uppercase">
                                Search
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<section style="height: 100px;">

</section>

{% if GOOGLE_MAPS_API_KEY %}
<script>
    let homeMap;
    let homeMarkers = [];
    const RADIUS = 1000; // 1000 meters = 1km

    // Place type mappings for Google Places API
    const placeTypes = [
        'establishment', // General business
        'hospital', // Healthcare
        'school', // Education
        'university', // Education
        'restaurant', // Food & Restaurants
        'food', // Food & Restaurants
        'meal_takeaway', // Food & Restaurants
        'meal_delivery', // Food & Restaurants
        'cafe', // Food & Restaurants
        'bar', // Food & Restaurants
        'movie_theater', // Entertainment
        'amusement_park', // Entertainment
        'zoo', // Entertainment
        'night_club', // Entertainment
        'shopping_mall', // Shopping
        'store', // Shopping
        'supermarket', // Shopping
        'gym', // Sport
        'stadium', // Sport
        'travel_agency', // Travel & Tour
        'lodging', // Hotels
        'tourist_attraction' // Travel & Tour
    ];

    // Function to create custom marker icon with emoji/symbol
    function createMarkerIcon(category, typeColor) {
        // Use Unicode symbols/emoji for better visual representation
        const symbols = {
            'Healthcare': 'üè•',
            'Hotels': 'üè®',
            'Education': 'üéì',
            'Food & Restaurants': 'üçΩÔ∏è',
            'Entertainment': 'üé¨',
            'Shopping': 'üõçÔ∏è',
            'Sport': '‚öΩ',
            'Travel & Tour': '‚úàÔ∏è',
            'Business': 'üè¢'
        };
        
        const symbol = symbols[category] || 'üìç';
        
        // Create a canvas to draw the icon
        const canvas = document.createElement('canvas');
        canvas.width = 40;
        canvas.height = 40;
        const ctx = canvas.getContext('2d');
        
        // Draw white circle background
        ctx.beginPath();
        ctx.arc(20, 20, 18, 0, 2 * Math.PI);
        ctx.fillStyle = '#FFFFFF';
        ctx.fill();
        ctx.strokeStyle = typeColor;
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Draw emoji/symbol in center
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(symbol, 20, 20);
        
        return {
            url: canvas.toDataURL(),
            scaledSize: new google.maps.Size(40, 40),
            anchor: new google.maps.Point(20, 20)
        };
    }

    // Initialize map with current location
    function initHomeMap() {
        const mapElement = document.getElementById('homeMap');
        if (!mapElement || typeof google === 'undefined' || !google.maps) {
            console.error('Map element or Google Maps API not available');
            return;
        }

        // Default center (will be updated with user's location)
        const defaultCenter = { lat: 51.5074, lng: -0.1278 }; // London, UK

        // Initialize map
        homeMap = new google.maps.Map(mapElement, {
            zoom: 15,
            center: defaultCenter,
            mapTypeControl: true,
            streetViewControl: false,
            fullscreenControl: true,
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }]
                }
            ]
        });

        // Get user's current location and load nearby places
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Center map on user's location
                    homeMap.setCenter(userLocation);
                    homeMap.setZoom(15);

                    // Add marker for current location with better icon
                    const currentMarker = new google.maps.Marker({
                        position: userLocation,
                        map: homeMap,
                        title: 'Your Current Location',
                        icon: {
                            url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                            scaledSize: new google.maps.Size(40, 40),
                            anchor: new google.maps.Point(20, 20)
                        },
                        animation: google.maps.Animation.DROP,
                        zIndex: 1000
                    });

                    // Add info window for current location
                    const currentInfoWindow = new google.maps.InfoWindow({
                        content: '<div style="padding: 10px;"><strong>üìç Your Current Location</strong><br>Lat: ' + userLocation.lat.toFixed(6) + '<br>Lng: ' + userLocation.lng.toFixed(6) + '</div>'
                    });

                    currentMarker.addListener('click', function() {
                        currentInfoWindow.open(homeMap, currentMarker);
                    });

                    // Try to get address using Geocoding API
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ location: userLocation }, function(results, status) {
                        if (status === 'OK' && results[0]) {
                            const address = results[0].formatted_address;
                            document.getElementById('locationInput').value = address;
                            currentInfoWindow.setContent('<div style="padding: 10px;"><strong>üìç Your Current Location</strong><br>' + address + '</div>');
                        }
                    });

                    console.log('Current location set:', userLocation);
                    console.log('Searching for places within ' + RADIUS + ' meters...');
                    
                    // Search for nearby places
                    searchNearbyPlaces(userLocation);
                },
                function(error) {
                    console.log('Geolocation error:', error.message);
                    // Keep default center (London)
                    const marker = new google.maps.Marker({
                        position: defaultCenter,
                        map: homeMap,
                        title: 'Default Location'
                    });
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        } else {
            console.log('Geolocation is not supported by this browser');
            // Show default location
            const marker = new google.maps.Marker({
                position: defaultCenter,
                map: homeMap,
                title: 'Default Location'
            });
        }
    }

    // Search for nearby places using Google Places API
    function searchNearbyPlaces(location) {
        if (!homeMap || !google.maps.places) {
            console.error('Map or Places service not available');
            return;
        }

        const service = new google.maps.places.PlacesService(homeMap);
        let allPlaces = [];
        let completedSearches = 0;

        // Search for each place type
        placeTypes.forEach(function(type, index) {
            const request = {
                location: new google.maps.LatLng(location.lat, location.lng),
                radius: RADIUS,
                type: type
            };

            service.nearbySearch(request, function(results, status, pagination) {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    // Filter out duplicates and add to allPlaces
                    results.forEach(function(place) {
                        if (!allPlaces.find(p => p.place_id === place.place_id)) {
                            allPlaces.push(place);
                        }
                    });
                }

                completedSearches++;

                // When all searches are complete, display markers
                if (completedSearches === placeTypes.length) {
                    displayPlacesOnMap(allPlaces, location);
                }
            });
        });
    }

    // Display places on map with markers
    function displayPlacesOnMap(places, userLocation) {
        // Clear existing markers (except current location)
        clearPlaceMarkers();

        console.log('Found ' + places.length + ' places within ' + RADIUS + ' meters');

        // Color mapping for different place types
        const typeColors = {
            'hospital': '#E91E63',    // Pink/Red for Healthcare
            'school': '#4285F4',      // Blue
            'university': '#4285F4',  // Blue
            'restaurant': '#EA4335',  // Red
            'food': '#EA4335',        // Red
            'meal_takeaway': '#EA4335', // Red
            'meal_delivery': '#EA4335', // Red
            'cafe': '#EA4335',        // Red
            'bar': '#EA4335',         // Red
            'movie_theater': '#FBBC04', // Yellow
            'amusement_park': '#FBBC04', // Yellow
            'zoo': '#FBBC04',         // Yellow
            'night_club': '#FBBC04',  // Yellow
            'shopping_mall': '#34A853', // Green
            'store': '#34A853',       // Green
            'supermarket': '#34A853', // Green
            'gym': '#FF6D00',         // Orange
            'stadium': '#FF6D00',     // Orange
            'travel_agency': '#9C27B0', // Purple
            'lodging': '#2196F3',     // Blue for Hotels
            'tourist_attraction': '#9C27B0', // Purple
            'establishment': '#757575' // Gray
        };

        // Get category name from place types
        function getCategoryName(types) {
            if (types.some(t => ['hospital'].includes(t))) return 'Healthcare';
            if (types.some(t => ['lodging'].includes(t))) return 'Hotels';
            if (types.some(t => ['school', 'university'].includes(t))) return 'Education';
            if (types.some(t => ['restaurant', 'food', 'meal_takeaway', 'meal_delivery', 'cafe', 'bar'].includes(t))) return 'Food & Restaurants';
            if (types.some(t => ['movie_theater', 'amusement_park', 'zoo', 'night_club'].includes(t))) return 'Entertainment';
            if (types.some(t => ['shopping_mall', 'store', 'supermarket'].includes(t))) return 'Shopping';
            if (types.some(t => ['gym', 'stadium'].includes(t))) return 'Sport';
            if (types.some(t => ['travel_agency', 'tourist_attraction'].includes(t))) return 'Travel & Tour';
            return 'Business';
        }

        // Get icon symbol for category
        function getCategorySymbol(category) {
            const symbols = {
                'Healthcare': 'üè•',
                'Hotels': 'üè®',
                'Education': 'üéì',
                'Food & Restaurants': 'üçΩÔ∏è',
                'Entertainment': 'üé¨',
                'Shopping': 'üõçÔ∏è',
                'Sport': '‚öΩ',
                'Travel & Tour': '‚úàÔ∏è',
                'Business': 'üè¢'
            };
            return symbols[category] || 'üìç';
        }

        // Create markers for each place
        places.forEach(function(place) {
            const placeLocation = place.geometry.location;
            const category = getCategoryName(place.types);
            const typeColor = place.types.find(t => typeColors[t]) ? typeColors[place.types.find(t => typeColors[t])] : '#757575';
            const symbol = getCategorySymbol(category);

            // Create custom marker icon using canvas
            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');
            
            // Draw white circle background with border
            ctx.beginPath();
            ctx.arc(25, 25, 22, 0, 2 * Math.PI);
            ctx.fillStyle = '#FFFFFF';
            ctx.fill();
            ctx.strokeStyle = typeColor;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Draw shadow effect
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 4;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            // Draw emoji/symbol in center
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(symbol, 25, 25);

            const markerIcon = {
                url: canvas.toDataURL(),
                scaledSize: new google.maps.Size(50, 50),
                anchor: new google.maps.Point(25, 25)
            };

            const marker = new google.maps.Marker({
                position: placeLocation,
                map: homeMap,
                title: place.name + ' (' + category + ')',
                icon: markerIcon,
                animation: google.maps.Animation.DROP
            });

            // Create info window content with icon
            const rating = place.rating ? '<div style="margin-top: 5px;"><span style="color: #FFB800;">‚òÖ</span> ' + place.rating.toFixed(1) + ' (' + place.user_ratings_total + ' reviews)</div>' : '';
            const address = place.vicinity || (place.formatted_address || '');
            const infoContent = '<div style="padding: 12px; min-width: 220px; font-family: Arial, sans-serif;">' +
                '<div style="font-size: 20px; margin-bottom: 5px;">' + symbol + ' <strong style="font-size: 14px;">' + place.name + '</strong></div>' +
                '<div style="background: ' + typeColor + '; color: white; padding: 3px 8px; border-radius: 3px; display: inline-block; font-size: 11px; margin-bottom: 8px; font-weight: bold;">' + category + '</div><br>' +
                (address ? '<div style="font-size: 12px; color: #666; margin-top: 5px; line-height: 1.4;">üìç ' + address + '</div>' : '') +
                rating +
                '</div>';

            const infoWindow = new google.maps.InfoWindow({
                content: infoContent
            });

            marker.addListener('click', function() {
                // Close all other info windows
                homeMarkers.forEach(function(m) {
                    if (m.infoWindow) {
                        m.infoWindow.close();
                    }
                });
                infoWindow.open(homeMap, marker);
            });

            // Store marker and info window
            homeMarkers.push({
                marker: marker,
                infoWindow: infoWindow,
                place: place
            });
        });

        console.log('‚úÖ Displayed ' + homeMarkers.length + ' markers on map');
    }

    // Clear all place markers
    function clearPlaceMarkers() {
        homeMarkers.forEach(function(item) {
            if (item.marker) {
                item.marker.setMap(null);
            }
        });
        homeMarkers = [];
    }

    // Load Google Maps API and initialize map
    if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initHomeMap';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    } else {
        // Google Maps already loaded
        initHomeMap();
    }
</script>
{% else %}
<script>
    // If no API key, show a placeholder
    document.getElementById('homeMap').innerHTML = '<div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">Please configure GOOGLE_MAPS_API_KEY in settings</div>';
</script>
{% endif %}
