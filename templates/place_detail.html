<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ place.name|default:"Place details" }}</title>
    {% load static %}
    {% load place_photos %}
    {% load category_videos %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/accessadvisr-style.css' %}">
    <link rel="stylesheet" href="{% static 'css/place-detail.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        /* Override main CSS for detail page */
        body {
            overflow: visible !important;
            height: auto !important;
            min-height: 100vh;
        }
        html {
            overflow-x: hidden;
            overflow-y: auto;
        }
        /* Ensure menu bar is visible */
        .top-menu-bar {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        /* Photo gallery enhancements */
        .thumbnail-img {
            transition: all 0.3s ease;
        }
        .thumbnail-img:hover {
            transform: scale(1.05);
            border-color: #1976d2 !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .thumbnail-img.active {
            border-color: #1976d2 !important;
            box-shadow: 0 4px 12px rgba(25,118,210,0.4);
            transform: scale(1.05);
        }
        #main-photo {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
        }
        
        /* Custom Notification Styles - No Popup */
        .custom-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            min-width: 300px;
            max-width: 450px;
            padding: 16px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid #2196F3;
        }
        
        .custom-notification-success {
            border-left-color: #4CAF50;
        }
        
        .custom-notification-error {
            border-left-color: #F44336;
        }
        
        .custom-notification-warning {
            border-left-color: #FF9800;
        }
        
        .custom-notification-info {
            border-left-color: #2196F3;
        }
        
        .notif-icon {
            font-size: 24px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .custom-notification-success .notif-icon {
            color: #4CAF50;
        }
        
        .custom-notification-error .notif-icon {
            color: #F44336;
        }
        
        .custom-notification-warning .notif-icon {
            color: #FF9800;
        }
        
        .custom-notification-info .notif-icon {
            color: #2196F3;
        }
        
        .notif-message {
            flex: 1;
            color: #333;
            font-size: 15px;
            line-height: 1.4;
        }
        
        .notif-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: color 0.2s;
        }
        
        .notif-close:hover {
            color: #333;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notif-fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }
        
        @media (max-width: 768px) {
            .custom-notification {
                left: 10px;
                right: 10px;
                max-width: none;
                min-width: auto;
            }
        }
    </style>
</head>
<body{% if user.is_authenticated %} class="user-authenticated"{% endif %}>
        {% include 'components/navbar.html' %}
        
        {% if place.error %}
        <div class="error-container" style="max-width: 800px; margin: 100px auto; padding: 40px; text-align: center; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <h2 style="color: #dc3545; font-size: 2rem; margin-bottom: 20px;">‚ö†Ô∏è Error Loading Place Details</h2>
            <p style="font-size: 1.2rem; color: #666; margin-bottom: 10px;"><strong>Status:</strong> {{ place.error }}</p>
            {% if error_message %}
            <p style="color: #888; margin-bottom: 20px;">{{ error_message }}</p>
            {% endif %}
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <p style="color: #555; margin-bottom: 10px;"><strong>Possible reasons:</strong></p>
                <ul style="text-align: left; color: #666; max-width: 500px; margin: 0 auto;">
                    <li>Invalid or expired place ID</li>
                    <li>Google Maps API key not configured or invalid</li>
                    <li>API request limit exceeded</li>
                    <li>Network connectivity issues</li>
                </ul>
            </div>
            <div style="margin-top: 30px;">
                <a href="/" style="display: inline-block; padding: 12px 30px; background: #1976d2; color: white; text-decoration: none; border-radius: 6px; font-weight: 500;">Go to Homepage</a>
                <a href="javascript:window.history.back()" style="display: inline-block; padding: 12px 30px; background: #6c757d; color: white; text-decoration: none; border-radius: 6px; font-weight: 500; margin-left: 10px;">Go Back</a>
            </div>
            </div>
        {% elif not place.name %}
        <div class="error-container" style="max-width: 800px; margin: 100px auto; padding: 40px; text-align: center; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <h2 style="color: #dc3545; font-size: 2rem; margin-bottom: 20px;">‚ö†Ô∏è Place Not Found</h2>
            <p style="font-size: 1.1rem; color: #666; margin-bottom: 30px;">The requested place could not be found or does not exist.</p>
            <div style="margin-top: 30px;">
                <a href="/" style="display: inline-block; padding: 12px 30px; background: #1976d2; color: white; text-decoration: none; border-radius: 6px; font-weight: 500;">Go to Homepage</a>
                <a href="/listings/" style="display: inline-block; padding: 12px 30px; background: #28a745; color: white; text-decoration: none; border-radius: 6px; font-weight: 500; margin-left: 10px;">Browse Listings</a>
            </div>
            </div>
        {% else %}
        {% with place.photos.0 as hero_photo %}
        <!-- Banner Section -->
        <div class="detail-banner" {% if hero_photo and GOOGLE_MAPS_API_KEY %}style="background-image:url('{{ hero_photo|get_place_photo_url:GOOGLE_MAPS_API_KEY|safe }}'); background-size: cover; background-position: center;"{% else %}style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"{% endif %}>
            <div class="banner-overlay"></div>
            <div class="banner-content">
                <!-- Main content in bottom-left -->
                <div class="banner-main-content">
                    <div class="profile-avatar-large">
                        {% if place.photos.1 and GOOGLE_MAPS_API_KEY %}
                            <img src="{{ place.photos.1|get_place_photo_url:GOOGLE_MAPS_API_KEY|safe }}" 
                                 alt="{{ place.name }}" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                            <div class="avatar-fallback" style="display:none;">{{ place.name|first|upper }}</div>
                        {% else %}
                            <div class="avatar-fallback">{{ place.name|first|upper }}</div>
                        {% endif %}
                    </div>
                    <div class="banner-text-content">
                        <h1 class="banner-title">{{ place.name }}</h1>
                        <div class="banner-tagline">
                            {% if location.description %}
                                {{ location.description|truncatewords:10 }}
                            {% elif place.editorial_summary and place.editorial_summary.overview %}
                                {{ place.editorial_summary.overview|truncatewords:10 }}
                            {% elif place.types %}
                                {{ place.types.0|title }}{% if place.types.1 %}, {{ place.types.1|title }}{% endif %}
                            {% else %}
                                Villa, food for you
                {% endif %}
                        </div>
                        <div class="banner-categories">
                            {% if place.types %}
                                {% for type in place.types|slice:":5" %}
                                    <span>{{ type|title }}</span>{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        <!-- Contact info below categories -->
                        <div class="banner-contact-inline">
                            {% if place.international_phone_number or place.formatted_phone_number %}
                            <div class="contact-phone">
                                <span class="contact-icon">üìû</span>
                                <span class="phone-masked">+88-123-4***</span>
                                <button class="btn-show-phone" onclick="showPhone()">show</button>
                                <span class="phone-full" style="display:none;">{{ place.international_phone_number|default:place.formatted_phone_number }}</span>
                            </div>
                            {% endif %}
                            <div class="contact-address">
                                <span class="contact-icon">üìç</span>
                                <span>
                {% if place.formatted_address %}
                                        {{ place.formatted_address }}
                                    {% elif place.vicinity %}
                                        {{ place.vicinity }}
                {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rating and buttons in bottom-right -->
                <div class="banner-right-section">
                    <div class="banner-rating">
                        <div class="rating-value-large">{{ place.rating|default:"4.0" }}</div>
                    </div>
                    <div class="banner-actions">
                        <button class="btn-banner-action btn-save">
                            <span class="btn-icon">‚ù§Ô∏è</span>
                            <span>Save</span>
                        </button>
                        <button class="btn-banner-action btn-review">
                            <span class="btn-icon">üí¨</span>
                            <span>Submit Review</span>
                        </button>
                        <button class="btn-banner-action btn-share">
                            <span class="btn-icon">üîó</span>
                            <span>Share</span>
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
        {% endwith %}

        <!-- Main Content -->
        <div class="detail-wrapper">
            <div class="detail-container">
        <div class="detail-body">
                    <!-- Main Content Column -->
            <div class="detail-main">
                        <!-- Description Section -->
                <div class="detail-section">
                            <h3>Description</h3>
                            <p>
                                {% if location.description %}
                                    {{ location.description }}
                                {% elif place.editorial_summary and place.editorial_summary.overview %}
                                    {{ place.editorial_summary.overview }}
                                {% elif place.types %}
                                    {{ place.name }} is a {{ place.types.0|title }} located at {{ place.formatted_address|default:place.vicinity }}. {% if place.rating %}It has a rating of {{ place.rating }} out of 5{% if place.user_ratings_total %} based on {{ place.user_ratings_total }} reviews{% endif %}.{% endif %}
                                {% else %}
                                    {{ place.name }} is located at {{ place.formatted_address|default:place.vicinity }}.
                    {% endif %}
                            </p>
                        </div>

                        <!-- What We're Looking For -->
                        <div class="detail-section">
                            <h3>What We're Looking For</h3>
                            {% if location.what_we_looking_for %}
                                <div class="what-we-looking-for">
                                    {{ location.what_we_looking_for|linebreaks }}
                                </div>
                            {% else %}
                                <ul class="bullet-list">
                                    <li>A composer with experience or interest in creating music for dance, particularly in environments where accessibility matters.</li>
                                    <li>Someone who can collaborate with performers to integrate visual, spatial, and sensory considerations.</li>
                                    <li>An ability to adapt compositions so they work well for both trained dancers and audience members with sensory or mobility differences.</li>
                                </ul>
                    {% endif %}
                </div>

                        <!-- Why This Matters -->
                        <div class="detail-section">
                            <h3>Why This Matters</h3>
                            <p>
                                {% if location.why_this_matters %}
                                    {{ location.why_this_matters }}
                                {% else %}
                                    Art and performance should be for everyone. This project aims to set a higher standard for genuine accessibility. We believe that everyone should have the opportunity to experience and participate in the arts, regardless of their abilities or circumstances.
                    {% endif %}
                            </p>
                        </div>

                        <!-- How to Apply -->
                        <div class="detail-section">
                            <h3>How to Apply</h3>
                            <p>
                                {% if location.how_to_apply %}
                                    {{ location.how_to_apply }}
                                {% else %}
                                    If you're ready to compose something meaningful, share your portfolio and approach to accessible composition. We're looking for creative minds who understand that great art is inclusive art. Please send your application with examples of your work and a brief statement about your approach to accessible performance.
                    {% endif %}
                            </p>
                </div>

                        <!-- Maps Section -->
                <div class="detail-section">
                            <div class="maps-header">
                                <h3>Maps</h3>
                                <div class="map-tabs">
                                    <button class="map-tab active" data-tab="map">
                                        <span class="map-icon map-icon-map">
                                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M9 1L2 4V15L9 12L16 15V4L9 1Z" stroke="#dc3545" stroke-width="1.5" fill="none"/>
                                                <path d="M9 1V12M2 4L16 4" stroke="#dc3545" stroke-width="1.5"/>
                                            </svg>
                                        </span>
                                        <span>Map</span>
                                    </button>
                                    <button class="map-tab" data-tab="streetview">
                                        <span class="map-icon map-icon-streetview">
                                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="9" cy="12" r="4" fill="#dc3545"/>
                                                <circle cx="9" cy="6" r="2.5" fill="#dc3545"/>
                                            </svg>
                                        </span>
                                        <span>Street View</span>
                                    </button>
                                    <button class="map-tab" data-tab="directions">
                                        <span class="map-icon map-icon-directions">
                                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M2 9L16 2L13 9L16 16L2 9Z" fill="#dc3545"/>
                                            </svg>
                                        </span>
                                        <span>Get Directions</span>
                                    </button>
                                </div>
                            </div>
                            <div class="map-container-wrapper">
                                <div id="detail-map" class="detail-map">
                                    <div class="map-controls-overlay">
                                        <div class="map-zoom-control">+</div>
                                        <div class="map-zoom-control">‚àí</div>
                                    </div>
                                    <div class="map-error" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f5f5f5; padding: 20px; text-align: center;">
                                        <div class="map-error-icon" style="font-size: 3rem; color: #dc3545; margin-bottom: 10px;">‚ö†Ô∏è</div>
                                        <div class="map-error-title" style="font-size: 1.3rem; font-weight: bold; color: #333; margin-bottom: 10px;">Map Loading Error</div>
                                        <div class="map-error-message" style="color: #666; line-height: 1.6;">
                                            {% if not GOOGLE_MAPS_API_KEY %}
                                                Google Maps API key is not configured. Please add GOOGLE_MAPS_API_KEY to your .env file.
                                            {% else %}
                                                Loading map... If this persists, check the browser console for details.
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div id="street-view" class="detail-map" style="display:none;">
                                    <div class="map-controls-overlay">
                                        <div class="map-zoom-control">+</div>
                                        <div class="map-zoom-control">‚àí</div>
                                    </div>
                                    <div class="map-error" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f5f5f5; padding: 20px; text-align: center;">
                                        <div class="map-error-icon" style="font-size: 3rem; color: #dc3545; margin-bottom: 10px;">‚ö†Ô∏è</div>
                                        <div class="map-error-title" style="font-size: 1.3rem; font-weight: bold; color: #333; margin-bottom: 10px;">Street View Loading Error</div>
                                        <div class="map-error-message" style="color: #666; line-height: 1.6;">Street View is loading... If this persists, try the Map view instead.</div>
                                    </div>
                                </div>
                                <div id="directions-panel" class="directions-panel" style="display:none;">
                                    <a href="https://www.google.com/maps/dir/?api=1&destination={{ lat }},{{ lng }}" target="_blank" class="btn-directions">
                                        Open in Google Maps
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Listing Amenities -->
                <div class="detail-section">
                            <h3>Listing Amenities</h3>
                            <div class="amenities-grid">
                                {% for amenity in all_amenities %}
                                    <a href="{% url 'listings' %}?amenity={{ amenity.name|urlencode }}" class="amenity-item amenity-link">
                                        <input type="checkbox" 
                                               {% if location and amenity in location.amenities.all %}checked{% endif %}
                                               disabled>
                                        <span>{{ amenity.icon|default:"" }} {{ amenity.name }}</span>
                                    </a>
                                {% empty %}
                                    <!-- Default amenities from image - 3 columns layout -->
                                    <a href="{% url 'listings' %}?amenity={{ 'Accepts Credit Cards'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Accepts Credit Cards</span></a>
                                    <a href="{% url 'listings' %}?amenity={{ 'Alarm System'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Alarm System</span></a>
                                    <a href="{% url 'listings' %}?amenity={{ 'Bike Parking'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Bike Parking</span></a>
                                    <a href="{% url 'listings' %}?amenity={{ 'Coupons'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Coupons</span></a>
                                    <a href="{% url 'listings' %}?amenity={{ 'Elevator'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Elevator</span></a>
                                    <a href="{% url 'listings' %}?amenity={{ 'Outdoor Seating'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Outdoor Seating</span></a>
                                    <a href="{% url 'listings' %}?amenity={{ 'Parking Street'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Parking Street</span></a>
                                    <a href="{% url 'listings' %}?amenity={{ 'Reservations'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Reservations</span></a>
                                    <a href="{% url 'listings' %}?amenity={{ 'Security Cameras'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Security Cameras</span></a>
                                    <a href="{% url 'listings' %}?amenity={{ 'Smoking Allowed'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Smoking Allowed</span></a>
                                    <a href="{% url 'listings' %}?amenity={{ 'Wheelchair Accessible'|urlencode }}" class="amenity-item amenity-link"><input type="checkbox" checked disabled><span>Wheelchair Accessible</span></a>
                        {% endfor %}
                </div>
                </div>

                        <!-- Photos Section -->
                {% if place.photos and place.photos|length > 0 %}
                <div class="detail-section">
                    <h3>Photos ({{ place.photos|length }})</h3>
                            <div class="photo-gallery">
                                <div class="photo-main">
                                    <img id="main-photo" 
                                         src="" 
                                         alt="{{ place.name }}"
                                         style="display: none; width: 100%; height: 100%; object-fit: contain;"
                                         onerror="console.error('Failed to load photo:', this.src); this.style.display='none'; document.getElementById('photo-placeholder').style.display='flex';">
                                    <div id="photo-placeholder" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; min-height: 400px; background: #f5f5f5; color: #999; font-size: 1.1rem;">
                                        Click on a thumbnail to view image
                                    </div>
                                    <button class="photo-nav photo-prev" onclick="changePhoto(-1)" style="display: none;">‚Äπ</button>
                                    <button class="photo-nav photo-next" onclick="changePhoto(1)" style="display: none;">‚Ä∫</button>
                                </div>
                                <div class="photo-thumbnails" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                                    {% for p in place.photos|slice:":10" %}
                                        <img src="{{ p|get_place_photo_url:GOOGLE_MAPS_API_KEY|safe }}" 
                                             alt="{{ place.name }} - Photo {{ forloop.counter }}"
                                             data-photo-index="{{ forloop.counter0 }}"
                                             data-photo-url="{{ p|get_place_photo_url:GOOGLE_MAPS_API_KEY|safe }}"
                                             class="thumbnail-img"
                                             loading="lazy"
                                             onerror="console.error('Thumbnail failed:', this.src); this.style.display='none';"
                                             onmouseover="this.style.borderColor='#4285F4'; this.style.opacity='0.8';"
                                             onmouseout="if(!this.classList.contains('active')) { this.style.borderColor='transparent'; this.style.opacity='1'; }"
                                             style="display: block; width: 120px; height: 80px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s;">
                                    {% endfor %}
                                </div>
                    </div>
                </div>
                        {% else %}
                        <div class="detail-section">
                            <h3>Photos</h3>
                            <div class="photo-gallery">
                                <div style="padding: 40px; text-align: center; background: #f5f5f5; border-radius: 8px;">
                                    <p style="color: #999; font-size: 1.1rem;">üì∑ No photos available for this place</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Video Section -->
                        <div class="detail-section">
                            <h3>Video</h3>
                            <div class="video-container">
                                {% get_video_embed_url location place.types request as video_url %}
                                <iframe src="{{ video_url }}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                        referrerpolicy="strict-origin-when-cross-origin" 
                                        allowfullscreen></iframe>
                            </div>
            </div>

                        <!-- Reviews Section -->
                <div class="detail-section">
                            <h3 id="reviews-count">{% if reviews|length > 0 %}{{ reviews|length }} Review{{ reviews|length|pluralize }}{% elif place.reviews and place.reviews|length > 0 %}{{ place.reviews|length }} Review{{ place.reviews|length|pluralize }}{% else %}1 Review{% endif %}</h3>
                            <div class="reviews-list" id="reviews-list">
                                {% if reviews|length > 0 %}
                                    {% for r in reviews %}
                                    <div class="review-item" data-review-id="{{ r.id }}">
                                        <div class="review-avatar">
                                            <span>{{ r.author_name|first|upper }}</span>
                                        </div>
                                        <div class="review-content">
                                            <div class="review-header">
                                                <div class="review-author-info">
                                                    <strong>{{ r.author_name }}</strong>
                                                    <span class="review-date">{{ r.created_at|date:"F d, Y" }}</span>
                                                </div>
                                                <span class="review-rating-top">{{ r.get_average_rating }}</span>
                                            </div>
                                            <div class="review-text">{{ r.review_text }}</div>
                                            <div class="review-actions" data-author-email="{{ r.author_email }}">
                                                <button class="review-btn review-like" data-review-id="{{ r.id }}">üëç {{ r.likes }}</button>
                                                <button class="review-btn review-dislike" data-review-id="{{ r.id }}">üëé {{ r.dislikes }}</button>
                                                <button class="review-btn review-heart" data-review-id="{{ r.id }}">‚ù§Ô∏è {{ r.hearts }}</button>
                                                <a href="#" class="review-link review-reply" data-review-id="{{ r.id }}">üí¨ Reply</a>
                                                {% if user.is_authenticated and user.email == r.author_email %}
                                                <a href="#" class="review-link review-edit" data-review-id="{{ r.id }}">‚úèÔ∏è Edit</a>
                                                {% endif %}
                                            </div>
                                            <!-- Replies Section -->
                                            {% if r.replies.all %}
                                                <div class="replies-list" style="margin-top: 1rem; padding-left: 1.5rem; border-left: 2px solid #e0e0e0;">
                                                    {% for reply in r.replies.all %}
                                                        {% if reply.is_active %}
                                                        <div class="reply-item" data-reply-id="{{ reply.id }}" data-review-id="{{ r.id }}" style="margin-bottom: 0.75rem; padding: 0.75rem; background: #f9f9f9; border-radius: 6px;">
                                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                                                <strong style="font-size: 0.9rem; color: #333;">{{ reply.author_name }}</strong>
                                                                <span style="color: #777; font-size: 0.85rem;">{{ reply.created_at|date:"F d, Y" }}</span>
                                                            </div>
                                                            <div style="color: #555; font-size: 0.9rem; line-height: 1.5; margin-bottom: 0.5rem;">{{ reply.reply_text }}</div>
                                                            <div class="review-actions" data-author-email="{{ reply.author_email }}">
                                                                <button class="review-btn review-like" data-reply-id="{{ reply.id }}" data-type="reply">üëç {{ reply.likes }}</button>
                                                                <button class="review-btn review-dislike" data-reply-id="{{ reply.id }}" data-type="reply">üëé {{ reply.dislikes }}</button>
                                                                <button class="review-btn review-heart" data-reply-id="{{ reply.id }}" data-type="reply">‚ù§Ô∏è {{ reply.hearts }}</button>
                                                                <a href="#" class="review-link review-reply" data-reply-id="{{ reply.id }}" data-review-id="{{ r.id }}" data-type="reply">üí¨ Reply</a>
                                                                {% if user.is_authenticated and user.email == reply.author_email %}
                                                                <a href="#" class="review-link review-edit" data-reply-id="{{ reply.id }}" data-type="reply">‚úèÔ∏è Edit</a>
                                                                {% endif %}
                                                            </div>
                                                            <!-- Nested Replies (replies to this reply) -->
                                                            {% if reply.child_replies.all %}
                                                                <div class="nested-replies-list" style="margin-top: 0.75rem; padding-left: 1.5rem; border-left: 2px solid #e0e0e0;">
                                                                    {% for nested_reply in reply.child_replies.all %}
                                                                        {% if nested_reply.is_active %}
                                                                        <div class="reply-item nested-reply" data-reply-id="{{ nested_reply.id }}" data-review-id="{{ r.id }}" style="margin-bottom: 0.5rem; padding: 0.75rem; background: #f0f0f0; border-radius: 6px;">
                                                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                                                                <strong style="font-size: 0.85rem; color: #333;">{{ nested_reply.author_name }}</strong>
                                                                                <span style="color: #777; font-size: 0.8rem;">{{ nested_reply.created_at|date:"F d, Y" }}</span>
                                                                            </div>
                                                                            <div style="color: #555; font-size: 0.85rem; line-height: 1.5; margin-bottom: 0.5rem;">{{ nested_reply.reply_text }}</div>
                                                                            <div class="review-actions" data-author-email="{{ nested_reply.author_email }}">
                                                                                <button class="review-btn review-like" data-reply-id="{{ nested_reply.id }}" data-type="reply">üëç {{ nested_reply.likes }}</button>
                                                                                <button class="review-btn review-dislike" data-reply-id="{{ nested_reply.id }}" data-type="reply">üëé {{ nested_reply.dislikes }}</button>
                                                                                <button class="review-btn review-heart" data-reply-id="{{ nested_reply.id }}" data-type="reply">‚ù§Ô∏è {{ nested_reply.hearts }}</button>
                                                                                <a href="#" class="review-link review-reply" data-reply-id="{{ nested_reply.id }}" data-review-id="{{ r.id }}" data-type="reply">üí¨ Reply</a>
                                                                                {% if user.is_authenticated and user.email == nested_reply.author_email %}
                                                                                <a href="#" class="review-link review-edit" data-reply-id="{{ nested_reply.id }}" data-type="reply">‚úèÔ∏è Edit</a>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% elif place.reviews and place.reviews|length > 0 %}
                                    {% for r in place.reviews %}
                                    <div class="review-item">
                                        <div class="review-avatar">
                                            <span>{{ r.author_name|first|upper|default:"A" }}</span>
                                        </div>
                                        <div class="review-content">
                                            <div class="review-header">
                                                <div class="review-author-info">
                                                    <strong>{{ r.author_name|default:"admin" }}</strong>
                                                    <span class="review-date">{{ r.relative_time_description|default:"January 21, 2020" }}</span>
                                                </div>
                                                <span class="review-rating-top">{{ r.rating|default:"4.5" }}</span>
                                            </div>
                                            <div class="review-text">{{ r.text|default:"At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias." }}</div>
                                            <div class="review-actions">
                                                <button class="review-btn review-like">üëç 4</button>
                                                <button class="review-btn review-dislike">üëé 1</button>
                                                <button class="review-btn review-heart">‚ù§Ô∏è 1</button>
                                                <a href="#" class="review-link review-reply">üí¨ Reply</a>
                                                <!-- No edit button for Google reviews -->
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <!-- Default review if none available -->
                                    <div class="review-item">
                                        <div class="review-avatar">
                                            <span>A</span>
                                        </div>
                                        <div class="review-content">
                                            <div class="review-header">
                                                <div class="review-author-info">
                                                    <strong>admin</strong>
                                                    <span class="review-date">January 21, 2020</span>
                                                </div>
                                                <span class="review-rating-top">4.5</span>
                                            </div>
                                            <div class="review-text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias.</div>
                                            <div class="review-actions">
                                                <button class="review-btn review-like">üëç 4</button>
                                                <button class="review-btn review-dislike">üëé 1</button>
                                                <button class="review-btn review-heart">‚ù§Ô∏è 1</button>
                                                <a href="#" class="review-link review-reply">üí¨ Reply</a>
                                                <a href="#" class="review-link review-edit">‚úèÔ∏è Edit</a>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                </div>

                        <!-- Add Review & Rate -->
                <div class="detail-section">
                            <h3>Add Review & Rate</h3>
                            <form class="review-form" id="reviewForm" onsubmit="submitReview(event); return false;">
                                <input type="hidden" id="place_id" value="{{ place_id }}">
                                <input type="hidden" id="place_name" value="{{ place.name|default:'' }}">
                                <div class="rating-sliders">
                                    <div class="rating-item" data-category="quality">
                                        <label class="rating-label-left">Quality</label>
                                        <div class="star-rating" data-rating="5" data-color="green" id="quality-rating">
                                            <span class="star" data-value="1">‚≠ê</span>
                                            <span class="star" data-value="2">‚≠ê</span>
                                            <span class="star" data-value="3">‚≠ê</span>
                                            <span class="star" data-value="4">‚≠ê</span>
                                            <span class="star" data-value="5">‚≠ê</span>
                                        </div>
                                        <span class="rating-label-right">Excellent üòé</span>
                                    </div>
                                    <div class="rating-item" data-category="location">
                                        <label class="rating-label-left">Location</label>
                                        <div class="star-rating" data-rating="5" data-color="yellow" id="location-rating">
                                            <span class="star" data-value="1">‚≠ê</span>
                                            <span class="star" data-value="2">‚≠ê</span>
                                            <span class="star" data-value="3">‚≠ê</span>
                                            <span class="star" data-value="4">‚≠ê</span>
                                            <span class="star" data-value="5">‚≠ê</span>
                                        </div>
                                        <span class="rating-label-right">Excellent üòé</span>
                                    </div>
                                    <div class="rating-item" data-category="service">
                                        <label class="rating-label-left">Service</label>
                                        <div class="star-rating" data-rating="5" data-color="green" id="service-rating">
                                            <span class="star" data-value="1">‚≠ê</span>
                                            <span class="star" data-value="2">‚≠ê</span>
                                            <span class="star" data-value="3">‚≠ê</span>
                                            <span class="star" data-value="4">‚≠ê</span>
                                            <span class="star" data-value="5">‚≠ê</span>
                                        </div>
                                        <span class="rating-label-right">Excellent üòé</span>
                                    </div>
                                    <div class="rating-item" data-category="price">
                                        <label class="rating-label-left">Price</label>
                                        <div class="star-rating" data-rating="5" data-color="red" id="price-rating">
                                            <span class="star" data-value="1">‚≠ê</span>
                                            <span class="star" data-value="2">‚≠ê</span>
                                            <span class="star" data-value="3">‚≠ê</span>
                                            <span class="star" data-value="4">‚≠ê</span>
                                            <span class="star" data-value="5">‚≠ê</span>
                                        </div>
                                        <span class="rating-label-right">Excellent üòé</span>
                                    </div>
                                </div>
                                
                                {% if not user.is_authenticated %}
                                <!-- Name and Email fields only for non-logged in users -->
                                <div class="form-row">
                                    <div class="form-group form-group-half">
                                        <input type="text" id="author_name" placeholder="Your Name" class="form-input" required>
                                    </div>
                                    <div class="form-group form-group-half">
                                        <input type="email" id="author_email" placeholder="your@mail.com" class="form-input" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="save_info"> Save my name, email, and website in this browser for the next time I comment.
                                    </label>
                                </div>
                                {% else %}
                                <!-- Show logged in user info -->
                                <div class="alert alert-info mb-3" style="background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%); border: 1px solid #90caf9; border-radius: 8px; padding: 12px 16px;">
                                    <i class="bi bi-info-circle me-2"></i>Posting as <strong>{{ user.username }}</strong> ({{ user.email }})
                                </div>
                                {% endif %}
                                <div class="form-group">
                                    <textarea id="review_text" placeholder="Your review" class="form-textarea" rows="5" required></textarea>
                                </div>
                                <div class="form-group">
                                    <div class="image-upload" id="imageUploadArea">
                                        <div class="upload-area">
                                            <div class="upload-text">Drop images to upload</div>
                                            <div class="upload-or">or</div>
                                            <div class="upload-action">
                                                <button type="button" class="btn-upload" id="galleryBtn">Gallery Images</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn-submit-review" data-requires-auth="review">SUBMIT REVIEW</button>
                            </form>
                        </div>
                    </div>

                    <!-- Sidebar Column -->
                    <div class="detail-sidebar">
                        <!-- Business Info -->
                        <div class="sidebar-section">
                            <h3 class="section-title-with-icon">
                                <span class="section-icon">‚úì</span>
                                <span>Business Info</span>
                                <a href="https://www.google.com/maps/dir/?api=1&destination={{ lat }},{{ lng }}" target="_blank" class="link-directions">Get Directions</a>
                            </h3>
                            <div id="sidebar-map" class="sidebar-map">
                                <div class="map-controls-overlay">
                                    <div class="map-zoom-control">+</div>
                                    <div class="map-zoom-control">‚àí</div>
                                </div>
                                <div class="map-error" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f5f5f5; padding: 20px; text-align: center;">
                                    <div class="map-error-icon" style="font-size: 2.5rem; color: #dc3545; margin-bottom: 8px;">‚ö†Ô∏è</div>
                                    <div class="map-error-title" style="font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 8px;">Loading Map...</div>
                                    <div class="map-error-message" style="color: #666; line-height: 1.5; font-size: 0.9rem;">
                                        {% if not GOOGLE_MAPS_API_KEY %}
                                            API key not configured
                                        {% else %}
                                            Initializing map...
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="info-item">
                                <strong>Address:</strong><br>
                                {% if place.formatted_address %}
                                    {{ place.formatted_address }}
                                {% elif place.vicinity %}
                                    {{ place.vicinity }}
                                {% endif %}
                            </div>
                            <div class="info-item">
                                <strong>Phone:</strong>
                    {% if place.international_phone_number %}
                                    <span class="phone-masked">+89-456-8****</span>
                                    <button class="btn-show-phone-small" onclick="showPhone()">show</button>
                                    <span class="phone-full" style="display:none;">{{ place.international_phone_number }}</span>
                    {% elif place.formatted_phone_number %}
                                    <span class="phone-masked">+89-456-8****</span>
                                    <button class="btn-show-phone-small" onclick="showPhone()">show</button>
                                    <span class="phone-full" style="display:none;">{{ place.formatted_phone_number }}</span>
                                {% endif %}
                            </div>
                            <div class="info-item">
                                <strong>Email:</strong>
                                {% if location.email %}
                                    <a href="mailto:{{ location.email }}">{{ location.email }}</a>
                    {% else %}
                                    <span>example@apus.com</span>
                    {% endif %}
                            </div>
                            <div class="info-item">
                                <strong>Website:</strong>
                                {% if location.website %}
                                    <a href="{{ location.website }}" target="_blank">{{ location.website|truncatechars:30 }}</a>
                                {% elif place.website %}
                                    <a href="{{ place.website }}" target="_blank">{{ place.website|truncatechars:30 }}</a>
                                {% else %}
                                    <a href="#" target="_blank">opusthemes.com</a>
                    {% endif %}
                </div>
                
                            <!-- Follow Us -->
                            <div class="info-item follow-us-item">
                                <strong>Follow Us</strong>
                                <div class="social-links">
                                    {% if location.social_facebook %}
                                        <a href="{{ location.social_facebook }}" target="_blank" class="social-icon facebook">
                                            <span class="social-text">f</span>
                                        </a>
                                    {% else %}
                                        <a href="#" target="_blank" class="social-icon facebook">
                                            <span class="social-text">f</span>
                                        </a>
                        {% endif %}
                                    {% if location.social_twitter %}
                                        <a href="{{ location.social_twitter }}" target="_blank" class="social-icon twitter">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z" fill="#dc3545"/>
                                            </svg>
                                        </a>
                    {% else %}
                                        <a href="#" target="_blank" class="social-icon twitter">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z" fill="#dc3545"/>
                                            </svg>
                                        </a>
                {% endif %}
                                    {% if location.social_google_plus %}
                                        <a href="{{ location.social_google_plus }}" target="_blank" class="social-icon google">
                                            <span class="social-text">g+</span>
                                        </a>
                                    {% else %}
                                        <a href="#" target="_blank" class="social-icon google">
                                            <span class="social-text">g+</span>
                                        </a>
                    {% endif %}
                                    <a href="#" target="_blank" class="social-icon instagram">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <rect x="2" y="2" width="20" height="20" rx="5" stroke="#dc3545" stroke-width="2" fill="none"/>
                                            <circle cx="12" cy="12" r="4" stroke="#dc3545" stroke-width="2" fill="none"/>
                                            <circle cx="17.5" cy="6.5" r="1.5" fill="#dc3545"/>
                                        </svg>
                                    </a>
                                    {% if location.social_pinterest %}
                                        <a href="{{ location.social_pinterest }}" target="_blank" class="social-icon pinterest">
                                            <span class="social-text">p</span>
                                        </a>
                                    {% else %}
                                        <a href="#" target="_blank" class="social-icon pinterest">
                                            <span class="social-text">p</span>
                                        </a>
                    {% endif %}
                                </div>
                            </div>
                </div>
                
                        <!-- Operating Hours -->
                        <div class="sidebar-section">
                            <h3 class="section-title-with-icon today-header">
                                <span class="section-icon">‚úì</span>
                                <span>Today</span>
                                <span class="hours-today">
                                    {% if place.current_opening_hours and place.current_opening_hours.open_now %}
                                        {% if place.current_opening_hours.weekday_text %}
                                            {% with place.current_opening_hours.weekday_text.0 as today_line %}
                                                {% if "Open" in today_line %}
                                                    {{ today_line|slice:"6:" }}
                                                {% else %}
                                                    Open {{ today_line|slice:"9:" }}
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            Open Now
                                        {% endif %}
                                    {% elif place.opening_hours and place.opening_hours.weekday_text %}
                                        {% with place.opening_hours.weekday_text.0 as today %}
                                            {% if "Open" in today %}
                                                {{ today|slice:"6:" }}
                                            {% else %}
                                                Open {{ today|slice:"9:" }}
                        {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        Open 6:00 am - 11:00 pm
                {% endif %}
                                </span>
                            </h3>
                            <div class="hours-list">
                                {% if place.current_opening_hours and place.current_opening_hours.weekday_text %}
                                    {% for line in place.current_opening_hours.weekday_text %}
                                        <div class="hours-item {% if 'Monday' in line %}hours-monday{% endif %} {% if 'Saturday' in line or 'Sunday' in line %}hours-all-day{% endif %}">{{ line }}</div>
                                    {% endfor %}
                                {% elif place.opening_hours and place.opening_hours.weekday_text %}
                        {% for line in place.opening_hours.weekday_text %}
                                        <div class="hours-item {% if 'Monday' in line %}hours-monday{% endif %} {% if 'Saturday' in line or 'Sunday' in line %}hours-all-day{% endif %}">{{ line }}</div>
                        {% endfor %}
                                {% else %}
                                    <div class="hours-item hours-monday">Monday 6:00 AM - 11:00 PM</div>
                                    <div class="hours-item">Tuesday 6:00 AM - 11:00 PM</div>
                                    <div class="hours-item">Wednesday 6:00 AM - 11:00 PM</div>
                                    <div class="hours-item">Thursday 6:00 AM - 11:00 PM</div>
                                    <div class="hours-item">Friday 6:00 AM - 11:00 PM</div>
                                    <div class="hours-item hours-all-day">Saturday Open All Day</div>
                                    <div class="hours-item hours-all-day">Sunday Open All Day</div>
                {% endif %}
            </div>
        </div>

                        <!-- Nearby listings -->
                        <div class="sidebar-section">
                            <h3 class="section-title-with-icon">
                                <span class="section-icon">‚úì</span>
                                <span>Nearby listings</span>
                            </h3>
                            <p class="nearby-text">Find more {% if place.types and place.types|length > 0 %}{{ place.types.0|title }}{% else %}Education{% endif %} near <strong>{{ place.name|default:"this location" }}</strong>.</p>
                        </div>

                        <!-- Browse Nearby -->
                        <div class="sidebar-section">
                            <h3 class="section-title-with-icon">
                                <span class="section-icon">‚úì</span>
                                <span>Browse Nearby</span>
                            </h3>
                            <div class="browse-categories">
                                <a href="#">Business</a>
                                <a href="#">Food & Restaurants</a>
                                <a href="#">Shopping</a>
                                <a href="#">Travel & Tour</a>
                                <a href="#">Show all</a>
                            </div>
                        </div>

                        <!-- Price Range -->
                        <div class="sidebar-section">
                            <h3 class="section-title-with-icon">
                                <span class="section-icon">‚úì</span>
                                <span>Price Range</span>
                            </h3>
                            <div class="price-range">
                                {% if place.price_level %}
                                    {% if place.price_level == 0 %}
                                        Free
                                    {% elif place.price_level == 1 %}
                                        $ Price Range $10 - $30
                                    {% elif place.price_level == 2 %}
                                        $$ Price Range $30 - $60
                                    {% elif place.price_level == 3 %}
                                        $$$ Price Range $60 - $100
                                    {% elif place.price_level == 4 %}
                                        $$$$ Price Range $100 - $120
                                    {% endif %}
                                {% else %}
                                    $$$$ Price Range $100 - $120
        {% endif %}
                            </div>
    </div>

                        <!-- Rating Average -->
                        <div class="sidebar-section">
                            <h3 class="section-title-with-icon">
                                <span class="section-icon">‚úì</span>
                                <span>Rating Average</span>
                            </h3>
                            <div class="rating-average">
                                <div class="avg-rating-value">
                                    <span class="rating-number">{% if place.rating %}{{ place.rating }}{% else %}4.5{% endif %}</span>
                                    <span class="rating-label-small">/5 Average</span>
                                </div>
                                <div class="rating-breakdown">
                                    <div class="rating-category">
                                        <span class="category-label">Quality</span>
                                        <span class="category-score">{% if place.rating %}{{ place.rating|floatformat:0 }}{% else %}5{% endif %}</span>
                                    </div>
                                    <div class="rating-category">
                                        <span class="category-label">Location</span>
                                        <span class="category-score">{% if place.rating %}{{ place.rating|add:"-0.5"|floatformat:0|default:"4" }}{% else %}4{% endif %}</span>
                                    </div>
                                    <div class="rating-category">
                                        <span class="category-label">Service</span>
                                        <span class="category-score">{% if place.rating %}{{ place.rating|add:"-0.5"|floatformat:0|default:"4" }}{% else %}4{% endif %}</span>
                                    </div>
                                    <div class="rating-category">
                                        <span class="category-label">Price</span>
                                        <span class="category-score">{% if place.rating %}{{ place.rating|floatformat:0 }}{% else %}5{% endif %}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Statistic -->
                        <div class="sidebar-section">
                            <h3 class="section-title-with-icon">
                                <span class="section-icon">‚úì</span>
                                <span>Statistic</span>
                            </h3>
                            <div class="statistics">
                                <div class="stat-item">
                                    <span class="stat-icon">üëÅÔ∏è</span>
                                    <span class="stat-text">{% if place.user_ratings_total %}{{ place.user_ratings_total|add:"10" }}{% else %}345{% endif %} Views</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-icon">‚ù§Ô∏è</span>
                                    <span class="stat-text">1 Favorite</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-icon">‚≠ê</span>
                                    <span class="stat-text">{% if place.user_ratings_total %}{{ place.user_ratings_total }}{% else %}1{% endif %} Rating</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-icon">üìÖ</span>
                                    <span class="stat-text">{% now "F d, Y" %}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Business -->
                        <div class="sidebar-section">
                            <h3 class="section-title-with-icon">
                                <span class="section-icon">‚úì</span>
                                <span>Contact Business</span>
                            </h3>
                            <div class="contact-business">
                                <div class="contact-avatar">
                                    <span>A</span>
                                </div>
                                <div class="contact-info">
                                    <strong>accessadvisr</strong><br>
                                    <span>example@apus.com</span>
                                </div>
                            </div>
                            <form class="contact-form" onsubmit="return false;">
                                <div class="form-group">
                                    <label class="form-label">Subject</label>
                                    <input type="text" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">E-mail</label>
                                    <input type="email" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Message</label>
                                    <textarea class="form-textarea" rows="4"></textarea>
                                </div>
                                <button type="submit" class="btn-send-message">Send Message</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Pass data to JavaScript via JSON -->
    <script type="application/json" id="place-data">
    {
        "videoUrl": {% if location.video_url %}"{{ location.video_url|escapejs }}"{% else %}null{% endif %},
        "photoUrls": [
            {% if place.photos and GOOGLE_MAPS_API_KEY %}
            {% for p in place.photos|slice:":10" %}
            "{{ p|get_place_photo_url:GOOGLE_MAPS_API_KEY|escapejs }}"{% if not forloop.last %},{% endif %}
            {% endfor %}
            {% endif %}
        ],
        "hasApiKey": {% if GOOGLE_MAPS_API_KEY %}"yes"{% else %}"no"{% endif %},
        "photoCount": {{ place.photos|length|default:0 }},
        "placeName": "{{ place.name|escapejs }}",
        "lat": {{ lat|default:0 }},
        "lng": {{ lng|default:0 }},
        "types": [{% if place.types %}{% for t in place.types %}"{{ t|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}]
    }
    </script>

    <!-- JavaScript -->
    <script>
        // CSRF Token helper function for AJAX requests
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Notification system (no popup alerts)
        function showNotification(message, type = 'info') {
            // Remove any existing notifications
            const existingNotif = document.querySelector('.custom-notification');
            if (existingNotif) {
                existingNotif.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'custom-notification custom-notification-' + type;
            
            // Icon based on type
            const icons = {
                'success': '‚úì',
                'error': '‚úó',
                'warning': '‚ö†',
                'info': '‚Ñπ'
            };
            const icon = icons[type] || icons['info'];
            
            notification.innerHTML = `
                <span class="notif-icon">${icon}</span>
                <span class="notif-message">${message}</span>
                <button class="notif-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('notif-fade-out');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        // Debug info
        console.log('=== Place Detail Page Debug ===');
        console.log('Place ID:', '{{ place_id }}');
        console.log('Has API Key:', {{ GOOGLE_MAPS_API_KEY|yesno:"true,false" }});
        {% if GOOGLE_MAPS_API_KEY %}
        console.log('API Key (first 10 chars):', '{{ GOOGLE_MAPS_API_KEY|slice:":10" }}...');
        {% else %}
        console.error('‚úó GOOGLE_MAPS_API_KEY is not set!');
        {% endif %}
        console.log('Lat/Lng:', {{ lat|default:0 }}, {{ lng|default:0 }});
        console.log('Photos count:', {{ place.photos|length|default:0 }});
        {% if place.photos and place.photos|length > 0 %}
        console.log('First photo exists:', true);
        {% endif %}
        
        // Photo gallery functionality
        let currentPhotoIndex = 0;
        let photos = [];
        let placeTypes = [{% if place.types %}{% for t in place.types %}"{{ t|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}];
        
        console.log('Initial place types from template:', placeTypes);
        
        // Initialize data from JSON script tag
        var placeDataScript = document.getElementById('place-data');
        if (placeDataScript) {
            try {
                var placeData = JSON.parse(placeDataScript.textContent);
                console.log('‚úì Place data loaded:', placeData);
                
                // Video is now handled server-side via template tag
                // No need for JavaScript video URL manipulation
                
                // Store place types for icon selection (override with JSON data if available)
                if (placeData.types && placeData.types.length > 0) {
                    placeTypes = placeData.types;
                    console.log('‚úì Place types from JSON:', placeTypes);
                } else if (placeTypes.length > 0) {
                    console.log('‚úì Using place types from template:', placeTypes);
                }
                
                // Initialize photos array
                if (placeData.photoUrls && placeData.photoUrls.length > 0) {
                    photos = placeData.photoUrls;
                    console.log('‚úì Loaded', photos.length, 'photos into array');
                    console.log('‚úì First photo URL:', photos[0]);
                } else {
                    console.warn('‚ö†Ô∏è No photos in placeData');
                }
            } catch (e) {
                console.error('‚úó Error parsing place data:', e);
            }
        } else {
            console.warn('‚ö†Ô∏è No place-data script tag found');
        }
        
        // Note: Fallback will load photos from thumbnails in initializeComponents if still empty

        function setMainPhoto(index) {
            if (photos.length === 0) return;
            
            // Ensure index is within bounds
            if (index < 0) index = 0;
            if (index >= photos.length) index = photos.length - 1;
            
            currentPhotoIndex = index;
            const mainPhoto = document.getElementById('main-photo');
            const placeholder = document.getElementById('photo-placeholder');
            const prevBtn = document.querySelector('.photo-prev');
            const nextBtn = document.querySelector('.photo-next');
            
            if (mainPhoto && photos[index]) {
                // Hide placeholder and show image
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
                
                // Remove any error state classes
                mainPhoto.classList.remove('error-state');
                mainPhoto.closest('.photo-main')?.classList.remove('error-state');
                
                mainPhoto.style.display = 'block';
                
                // Show navigation buttons
                if (prevBtn) prevBtn.style.display = 'block';
                if (nextBtn) nextBtn.style.display = 'block';
                
                // Simple direct image change with fade effect
                mainPhoto.style.opacity = '0';
                mainPhoto.style.transition = 'opacity 0.3s ease';
                
                // Set new image source
                const newSrc = photos[index];
                
                // Clear any previous error handlers
                mainPhoto.onerror = null;
                
                // Decode HTML entities in URL (fix &amp; to &) - fixes 400 Bad Request error
                const decodedSrc = newSrc.replace(/&amp;/g, '&');
                
                // Set the image source directly
                mainPhoto.src = decodedSrc;
                mainPhoto.alt = 'Photo ' + (index + 1);
                
                // Simple error handler that doesn't show error image
                mainPhoto.onerror = function() {
                    console.warn('Image failed to load:', decodedSrc);
                    // If image fails, show placeholder text instead of error image
                    if (placeholder) {
                        placeholder.style.display = 'flex';
                        placeholder.textContent = 'Image failed to load. Please try another image.';
                    }
                    mainPhoto.style.display = 'none';
                    if (prevBtn) prevBtn.style.display = 'none';
                    if (nextBtn) nextBtn.style.display = 'none';
                    this.onerror = null; // Prevent infinite loop
                };
                
                // Show image with fade effect
                setTimeout(() => {
                    mainPhoto.style.opacity = '1';
                }, 50);
            }
            
            // Update thumbnail active state
            document.querySelectorAll('.photo-thumbnails img').forEach((img, i) => {
                if (i === index) {
                    img.classList.add('active');
                    img.style.borderColor = '#4285F4';
                    img.style.opacity = '1';
                    img.style.transform = 'scale(1.05)';
                    // Scroll thumbnail into view if needed
                    img.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    img.classList.remove('active');
                    img.style.borderColor = 'transparent';
                    img.style.opacity = '1';
                    img.style.transform = 'scale(1)';
                }
            });
        }

        function changePhoto(direction) {
            if (photos.length === 0) return;
            
            // Calculate new index with wrap-around
            currentPhotoIndex = (currentPhotoIndex + direction + photos.length) % photos.length;
            setMainPhoto(currentPhotoIndex);
        }
        
        // Star rating labels and emojis
        const ratingLabels = {
            1: { text: 'Poor', emoji: 'üòû' },
            2: { text: 'Fair', emoji: 'üòê' },
            3: { text: 'Good', emoji: 'üôÇ' },
            4: { text: 'Very Good', emoji: 'üòä' },
            5: { text: 'Excellent', emoji: 'üòé' }
        };

        // Color classes for stars
        const starColors = {
            green: '#4caf50',
            yellow: '#ffc107',
            red: '#dc3545'
        };

        // Initialize star ratings when DOM is ready
        function initStarRatings() {
            const ratingItems = document.querySelectorAll('.rating-item');
            
            ratingItems.forEach(item => {
                const starRating = item.querySelector('.star-rating');
                const stars = starRating.querySelectorAll('.star');
                const labelRight = item.querySelector('.rating-label-right');
                const color = starRating.getAttribute('data-color');
                const currentRating = parseInt(starRating.getAttribute('data-rating')) || 5;
                
                // Set initial rating
                updateStarRating(item, currentRating, color);
                
                // Add click handlers to each star
                stars.forEach((star, index) => {
                    star.style.cursor = 'pointer';
                    star.addEventListener('click', function() {
                        const value = parseInt(this.getAttribute('data-value'));
                        updateStarRating(item, value, color);
                    });
                    
                    star.addEventListener('mouseenter', function() {
                        const value = parseInt(this.getAttribute('data-value'));
                        highlightStars(starRating, value, color);
                    });
                });
                
                starRating.addEventListener('mouseleave', function() {
                    const currentRating = parseInt(starRating.getAttribute('data-rating')) || 5;
                    highlightStars(starRating, currentRating, color);
                });
            });
        }

        function updateStarRating(item, rating, color) {
            const starRating = item.querySelector('.star-rating');
            const labelRight = item.querySelector('.rating-label-right');
            const stars = starRating.querySelectorAll('.star');
            
            starRating.setAttribute('data-rating', rating);
            highlightStars(starRating, rating, color);
            
            // Update label
            const labelData = ratingLabels[rating];
            if (labelData) {
                labelRight.textContent = `${labelData.text} ${labelData.emoji}`;
            }
        }

        function highlightStars(starRating, rating, color) {
            const stars = starRating.querySelectorAll('.star');
            const colorValue = starColors[color] || starColors.green;
            
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.style.color = colorValue;
                    star.style.opacity = '1';
                } else {
                    star.style.color = '#ddd';
                    star.style.opacity = '0.5';
                }
            });
        }

        // Image upload drag and drop functionality
        function initImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const galleryBtn = document.getElementById('galleryBtn');
            
            if (!uploadArea) return;

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadArea.classList.add('drag-over');
            }

            function unhighlight(e) {
                uploadArea.classList.remove('drag-over');
            }

            // Handle dropped files
            uploadArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            function handleFiles(files) {
                [...files].forEach(uploadFile);
            }

            function uploadFile(file) {
                if (file.type.startsWith('image/')) {
                    // Here you can add file upload logic
                    console.log('File selected:', file.name);
                    // You can show preview or upload to server
                }
            }

            // Gallery button click
            if (galleryBtn) {
                galleryBtn.addEventListener('click', function() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.multiple = true;
                    input.onchange = function(e) {
                        handleFiles(e.target.files);
                    };
                    input.click();
                });
            }
        }

        // Submit review function
        function submitReview(event) {
            event.preventDefault();
            
            console.log('=== Review Submission Started ===');
            
            const form = document.getElementById('reviewForm');
            const submitBtn = form.querySelector('.btn-submit-review');
            const originalText = submitBtn.textContent;
            
            // Get form data
            const placeId = document.getElementById('place_id').value;
            const placeName = document.getElementById('place_name').value;
            const reviewText = document.getElementById('review_text').value.trim();
            
            console.log('Place ID:', placeId);
            console.log('Place Name:', placeName);
            console.log('Review Text Length:', reviewText.length);
            
            // Get author info - only if fields exist (for non-logged-in users)
            const authorNameField = document.getElementById('author_name');
            const authorEmailField = document.getElementById('author_email');
            const saveInfoField = document.getElementById('save_info');
            
            const authorName = authorNameField ? authorNameField.value.trim() : '';
            const authorEmail = authorEmailField ? authorEmailField.value.trim() : '';
            const saveInfo = saveInfoField ? saveInfoField.checked : false;
            
            console.log('Is User Logged In:', {{ user.is_authenticated|yesno:"true,false" }});
            if (!{{ user.is_authenticated|yesno:"true,false" }}) {
                console.log('Author Name:', authorName);
                console.log('Author Email:', authorEmail);
            }
            
            // Get ratings
            const qualityRating = parseInt(document.getElementById('quality-rating').getAttribute('data-rating')) || 5;
            const locationRating = parseInt(document.getElementById('location-rating').getAttribute('data-rating')) || 5;
            const serviceRating = parseInt(document.getElementById('service-rating').getAttribute('data-rating')) || 5;
            const priceRating = parseInt(document.getElementById('price-rating').getAttribute('data-rating')) || 5;
            
            console.log('Ratings - Quality:', qualityRating, 'Location:', locationRating, 'Service:', serviceRating, 'Price:', priceRating);
            
            // Validation
            if (authorNameField && !authorName) {
                showNotification('Please enter your name', 'warning');
                console.error('Validation failed: Name is required');
                authorNameField.focus();
                return;
            }
            
            if (!reviewText) {
                showNotification('Please enter your review', 'warning');
                console.error('Validation failed: Review text is required');
                document.getElementById('review_text').focus();
                return;
            }
            
            if (!placeId) {
                showNotification('Place ID is missing', 'error');
                console.error('Validation failed: Place ID is missing');
                return;
            }
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'SUBMITTING...';
            submitBtn.style.opacity = '0.6';
            submitBtn.style.cursor = 'not-allowed';
            
            // Prepare data
            const data = {
                place_id: placeId,
                place_name: placeName,
                review_text: reviewText,
                quality_rating: qualityRating,
                location_rating: locationRating,
                service_rating: serviceRating,
                price_rating: priceRating,
            };
            
            // Only include author info if fields exist (for non-logged-in users)
            if (authorNameField) {
                data.author_name = authorName;
                data.author_email = authorEmail;
                data.save_info = saveInfo;
            }
            
            console.log('Submitting review data:', data);
            
            // Get CSRF token
            const csrfToken = getCookie('csrftoken');
            console.log('CSRF Token:', csrfToken ? 'Found' : 'Missing');
            
            // Submit review
            fetch('/api/reviews/submit/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok);
                return response.json().then(jsonData => {
                    return { status: response.status, ok: response.ok, data: jsonData };
                });
            })
            .then(({ status, ok, data: result }) => {
                console.log('Response data:', result);
                
                if (ok && result.success) {
                    // Show success message
                    console.log('Review submitted successfully!');
                    
                    // Show success notification without alert popup
                    showNotification('Review submitted successfully!', 'success');
                    
                    // Reset form
                    form.reset();
                    
                    // Reset ratings to 5
                    ['quality', 'location', 'service', 'price'].forEach(category => {
                        const ratingEl = document.getElementById(category + '-rating');
                        if (ratingEl) {
                            updateStarRating(ratingEl.closest('.rating-item'), 5, ratingEl.getAttribute('data-color'));
                        }
                    });
                    
                    // Reload page to show new review
                    console.log('Reloading page to show new review...');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    const errorMsg = result.error || 'Failed to submit review';
                    console.error('‚úó Error:', errorMsg);
                    console.error('Status:', status);
                    showNotification('Error: ' + errorMsg, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                }
            })
            .catch(error => {
                console.error('‚úó Network/Fetch Error:', error);
                console.error('Error details:', error.message);
                showNotification('An error occurred. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
            });
        }

        // Initialize review action buttons
        function initReviewActions() {
            // Get or create user interaction storage
            function getUserInteractions() {
                const stored = localStorage.getItem('reviewInteractions');
                return stored ? JSON.parse(stored) : {};
            }
            
            function saveUserInteractions(interactions) {
                localStorage.setItem('reviewInteractions', JSON.stringify(interactions));
            }
            
            function hasUserInteracted(reviewId, actionType) {
                const interactions = getUserInteractions();
                const key = `${reviewId}_${actionType}`;
                return interactions[key] === true;
            }
            
            function setUserInteraction(reviewId, actionType, value) {
                const interactions = getUserInteractions();
                const key = `${reviewId}_${actionType}`;
                interactions[key] = value;
                saveUserInteractions(interactions);
            }
            
            // Like, Dislike, Heart buttons (for both reviews and replies)
            document.querySelectorAll('.review-like, .review-dislike, .review-heart').forEach(button => {
                const reviewId = button.getAttribute('data-review-id');
                const replyId = button.getAttribute('data-reply-id');
                const itemId = reviewId || replyId;
                
                if (!itemId) return;
                
                const actionType = button.classList.contains('review-like') ? 'like' :
                                  button.classList.contains('review-dislike') ? 'dislike' : 'heart';
                
                // Check if user already interacted and set initial state
                if (hasUserInteracted(itemId, actionType)) {
                    button.classList.add('active');
                    button.style.opacity = '1';
                }
                
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (!itemId) return;
                    
                    // Check current state
                    const isCurrentlyActive = hasUserInteracted(itemId, actionType);
                    const willToggle = isCurrentlyActive;
                    
                    // Disable button temporarily to prevent rapid clicks
                    const originalText = this.textContent;
                    this.disabled = true;
                    
                    // Prepare request data
                    const requestData = {
                        action: actionType,
                        toggle: willToggle
                    };
                    
                    if (reviewId) {
                        requestData.review_id = reviewId;
                    } else if (replyId) {
                        requestData.reply_id = replyId;
                    }
                    
                    // Update engagement
                    fetch('/api/reviews/engagement/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify(requestData)
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            // Update button text with new count from server
                            const emoji = actionType === 'like' ? 'üëç' : actionType === 'dislike' ? 'üëé' : '‚ù§Ô∏è';
                            const count = result[actionType + 's'] || 0;
                            this.textContent = `${emoji} ${count}`;
                            
                            // Update interaction state in localStorage
                            if (result.is_active) {
                                setUserInteraction(itemId, actionType, true);
                                this.classList.add('active');
                                this.style.opacity = '1';
                            } else {
                                setUserInteraction(itemId, actionType, false);
                                this.classList.remove('active');
                                this.style.opacity = '0.7';
                            }
                        } else {
                            showNotification('Error: ' + (result.error || 'Failed to update'), 'error');
                        }
                        this.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('An error occurred. Please try again.', 'error');
                        this.textContent = originalText;
                        this.disabled = false;
                    });
                });
            });
            
            // Reply buttons - existing code continues...
            document.querySelectorAll('.review-reply').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const reviewId = this.getAttribute('data-review-id');
                    const replyId = this.getAttribute('data-reply-id');
                    const type = this.getAttribute('data-type');
                    
                    let targetElement, isNestedReply = false, parentReplyId = null;
                    
                    if (type === 'reply') {
                        const replyItem = this.closest('.reply-item');
                        targetElement = replyItem;
                        isNestedReply = true;
                        parentReplyId = replyId;
                    } else {
                        const reviewItem = this.closest('.review-item');
                        const reviewContent = reviewItem ? reviewItem.querySelector('.review-content') : null;
                        targetElement = reviewContent;
                        isNestedReply = false;
                    }
                    
                    if (!targetElement || !reviewId) return;
                    
                    // Check if form already exists
                    const existingForm = targetElement.querySelector('.reply-form');
                    if (existingForm) {
                        existingForm.remove();
                        return;
                    }
                    
                    // Create reply form
                    const form = document.createElement('div');
                    form.className = 'reply-form';
                    form.style.marginTop = '0.75rem';
                    form.style.padding = '1rem';
                    form.style.background = '#f5f5f5';
                    form.style.borderRadius = '8px';
                    
                    const authorNameField = document.getElementById('author_name');
                    const showAuthorFields = !!authorNameField;
                    
                    form.innerHTML = `
                        ${showAuthorFields ? `
                        <div style="margin-bottom: 0.75rem;">
                            <input type="text" id="reply-author-name" class="form-input" placeholder="Your Name *" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 0.5rem;">
                            <input type="email" id="reply-author-email" class="form-input" placeholder="Your Email *" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        ` : ''}
                        <textarea id="reply-text" class="form-textarea" placeholder="Write your reply..." style="width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 0.5rem; resize: vertical;"></textarea>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-submit-reply" style="padding: 0.5rem 1rem; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Submit Reply</button>
                            <button class="btn-cancel-reply" style="padding: 0.5rem 1rem; background: #999; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                        </div>
                    `;
                    
                    targetElement.appendChild(form);
                    
                    // Cancel button
                    form.querySelector('.btn-cancel-reply').addEventListener('click', function() {
                        form.remove();
                    });
                    
                    // Submit button
                    form.querySelector('.btn-submit-reply').addEventListener('click', function() {
                        const replyText = form.querySelector('#reply-text').value.trim();
                        
                        if (!replyText) {
                            alert('Please enter your reply');
                            return;
                        }
                        
                        let authorName = '', authorEmail = '';
                        if (showAuthorFields) {
                            const authorNameField = form.querySelector('#reply-author-name');
                            const authorEmailField = form.querySelector('#reply-author-email');
                            
                            if (authorNameField && authorEmailField) {
                                authorName = authorNameField.value.trim();
                                authorEmail = authorEmailField.value.trim();
                                
                                if (!authorName || !authorEmail) {
                                    alert('Please enter your name and email');
                                    return;
                                }
                            }
                        }
                        
                        this.disabled = true;
                        this.textContent = 'Submitting...';
                        
                        const requestData = {
                            review_id: reviewId,
                            reply_text: replyText
                        };
                        
                        if (showAuthorFields) {
                            requestData.author_name = authorName;
                            requestData.author_email = authorEmail;
                        }
                        
                        if (isNestedReply && parentReplyId) {
                            requestData.parent_reply_id = parentReplyId;
                        }
                        
                        // Submit reply
                        fetch('/api/reviews/reply/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify(requestData)
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                form.remove();
                                
                                const date = new Date(result.reply.created_at);
                                const dateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                                
                                const replyDiv = document.createElement('div');
                                replyDiv.className = isNestedReply ? 'reply-item nested-reply' : 'reply-item';
                                replyDiv.setAttribute('data-reply-id', result.reply.id);
                                replyDiv.setAttribute('data-review-id', reviewId);
                                replyDiv.style.marginBottom = isNestedReply ? '0.5rem' : '0.75rem';
                                replyDiv.style.padding = '0.75rem';
                                replyDiv.style.background = isNestedReply ? '#f0f0f0' : '#f9f9f9';
                                replyDiv.style.borderRadius = '6px';
                                
                                replyDiv.innerHTML = `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <strong style="font-size: ${isNestedReply ? '0.85rem' : '0.9rem'}; color: #333;">${result.reply.author_name}</strong>
                                        <span style="color: #777; font-size: ${isNestedReply ? '0.8rem' : '0.85rem'};">${dateStr}</span>
                                    </div>
                                    <div style="color: #555; font-size: ${isNestedReply ? '0.85rem' : '0.9rem'}; line-height: 1.5; margin-bottom: 0.5rem;">${result.reply.reply_text}</div>
                                    <div class="review-actions">
                                        <button class="review-btn review-like" data-reply-id="${result.reply.id}" data-type="reply">üëç 0</button>
                                        <button class="review-btn review-dislike" data-reply-id="${result.reply.id}" data-type="reply">üëé 0</button>
                                        <button class="review-btn review-heart" data-reply-id="${result.reply.id}" data-type="reply">‚ù§Ô∏è 0</button>
                                        <a href="#" class="review-link review-reply" data-reply-id="${result.reply.id}" data-review-id="${reviewId}" data-type="reply">üí¨ Reply</a>
                                        <a href="#" class="review-link review-edit" data-reply-id="${result.reply.id}" data-type="reply">‚úèÔ∏è Edit</a>
                                    </div>
                                `;
                                
                                if (isNestedReply) {
                                    const replyItem = targetElement;
                                    let nestedRepliesList = replyItem.querySelector('.nested-replies-list');
                                    if (!nestedRepliesList) {
                                        nestedRepliesList = document.createElement('div');
                                        nestedRepliesList.className = 'nested-replies-list';
                                        nestedRepliesList.style.marginTop = '0.75rem';
                                        nestedRepliesList.style.paddingLeft = '1.5rem';
                                        nestedRepliesList.style.borderLeft = '2px solid #e0e0e0';
                                        replyItem.appendChild(nestedRepliesList);
                                    }
                                    nestedRepliesList.appendChild(replyDiv);
                                } else {
                                    const reviewItem = targetElement.closest('.review-item');
                                    let repliesList = reviewItem.querySelector('.replies-list');
                                    if (!repliesList) {
                                        repliesList = document.createElement('div');
                                        repliesList.className = 'replies-list';
                                        repliesList.style.marginTop = '1rem';
                                        repliesList.style.paddingLeft = '1.5rem';
                                        repliesList.style.borderLeft = '2px solid #e0e0e0';
                                        targetElement.appendChild(repliesList);
                                    }
                                    repliesList.appendChild(replyDiv);
                                }
                                
                                setTimeout(() => {
                                    initReviewActions();
                                }, 100);
                                
                                replyDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            } else {
                                alert('Error: ' + (result.error || 'Failed to submit reply'));
                                this.disabled = false;
                                this.textContent = 'Submit Reply';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred. Please try again.');
                            this.disabled = false;
                            this.textContent = 'Submit Reply';
                        });
                    });
                });
            });
            
            // Edit buttons - Full implementation with API
            document.querySelectorAll('.review-edit').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Check if this is a reply or review
                    const isReply = this.getAttribute('data-type') === 'reply';
                    const replyId = this.getAttribute('data-reply-id');
                    
                    let reviewItem, reviewTextEl, currentText, itemId;
                    
                    if (isReply) {
                        // For replies
                        reviewItem = this.closest('.reply-item') || this.closest('[data-reply-id]');
                        reviewTextEl = reviewItem ? reviewItem.querySelector('div[style*="color: #555"]') : null;
                        itemId = replyId;
                    } else {
                        // For reviews
                        reviewItem = this.closest('.review-item');
                        reviewTextEl = reviewItem ? reviewItem.querySelector('.review-text') : null;
                        itemId = reviewItem ? reviewItem.getAttribute('data-review-id') : null;
                    }
                    
                    if (!reviewTextEl || !itemId) {
                        showNotification('Could not find item to edit', 'error');
                        return;
                    }
                    
                    currentText = reviewTextEl.textContent.trim();
                    
                    const editForm = document.createElement('div');
                    editForm.className = 'edit-form';
                    editForm.style.marginTop = '0.5rem';
                    editForm.innerHTML = `
                        <textarea class="form-textarea" style="width: 100%; margin-bottom: 0.5rem; min-height: 100px;">${currentText}</textarea>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-save-edit" style="padding: 0.5rem 1rem; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Save</button>
                            <button class="btn-cancel-edit" style="padding: 0.5rem 1rem; background: #999; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                        </div>
                    `;
                    
                    reviewTextEl.style.display = 'none';
                    reviewTextEl.parentNode.insertBefore(editForm, reviewTextEl.nextSibling);
                    
                    const textarea = editForm.querySelector('textarea');
                    const saveBtn = editForm.querySelector('.btn-save-edit');
                    const cancelBtn = editForm.querySelector('.btn-cancel-edit');
                    
                    // Focus textarea and select all text
                    textarea.focus();
                    textarea.select();
                    
                    // Cancel button
                    cancelBtn.addEventListener('click', function() {
                        reviewTextEl.style.display = 'block';
                        editForm.remove();
                    });
                    
                    // Save button
                    saveBtn.addEventListener('click', function() {
                        const newText = textarea.value.trim();
                        
                        if (!newText) {
                            showNotification('Text cannot be empty', 'warning');
                            textarea.focus();
                            return;
                        }
                        
                        if (newText === currentText) {
                            showNotification('No changes made', 'info');
                            reviewTextEl.style.display = 'block';
                            editForm.remove();
                            return;
                        }
                        
                        // Disable buttons during save
                        saveBtn.disabled = true;
                        cancelBtn.disabled = true;
                        saveBtn.textContent = 'Saving...';
                        saveBtn.style.opacity = '0.6';
                        
                        // Prepare data
                        const data = {
                            text: newText
                        };
                        
                        if (isReply) {
                            data.reply_id = itemId;
                        } else {
                            data.review_id = itemId;
                        }
                        
                        // Send update request
                        fetch('/api/reviews/update/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify(data)
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                showNotification('Updated successfully!', 'success');
                                reviewTextEl.textContent = newText;
                                reviewTextEl.style.display = 'block';
                                editForm.remove();
                            } else {
                                showNotification('Error: ' + (result.error || 'Failed to update'), 'error');
                                saveBtn.disabled = false;
                                cancelBtn.disabled = false;
                                saveBtn.textContent = 'Save';
                                saveBtn.style.opacity = '1';
                            }
                        })
                        .catch(error => {
                            console.error('Error updating:', error);
                            showNotification('Failed to update. Please try again.', 'error');
                            saveBtn.disabled = false;
                            cancelBtn.disabled = false;
                            saveBtn.textContent = 'Save';
                            saveBtn.style.opacity = '1';
                        });
                    });
                });
            });
        }
        
        // Initialize: Don't show any image initially
        // Only show when thumbnail is clicked
        // Initialize all components when DOM is ready
        function initializeComponents() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‚úì Initializing Components');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Fallback: Load photos from thumbnail elements if photos array is still empty
            if (photos.length === 0) {
                console.log('‚ö†Ô∏è Photos array empty, loading from DOM thumbnails...');
                const thumbnails = document.querySelectorAll('.photo-thumbnails img[data-photo-url]');
                if (thumbnails.length > 0) {
                    thumbnails.forEach(thumb => {
                        const photoUrl = thumb.getAttribute('data-photo-url');
                        if (photoUrl) {
                            photos.push(photoUrl);
                        }
                    });
                    console.log('‚úì Loaded', photos.length, 'photos from thumbnails');
                } else {
                    console.warn('‚ö†Ô∏è No photo thumbnails found in DOM');
                }
            }
            
            // Photo gallery initialization
            const mainPhoto = document.getElementById('main-photo');
            const placeholder = document.getElementById('photo-placeholder');
            const prevBtn = document.querySelector('.photo-prev');
            const nextBtn = document.querySelector('.photo-next');
            
            if (mainPhoto) {
                mainPhoto.style.display = 'none';
            }
            if (placeholder) {
                placeholder.style.display = 'flex';
            }
            if (prevBtn) {
                prevBtn.style.display = 'none';
            }
            if (nextBtn) {
                nextBtn.style.display = 'none';
            }
            
            // Remove active class from first thumbnail initially
            const firstThumbnail = document.querySelector('.photo-thumbnails img');
            if (firstThumbnail) {
                firstThumbnail.classList.remove('active');
            }
            
            // Add click event delegation for photo thumbnails
            const photoThumbnails = document.querySelector('.photo-thumbnails');
            if (photoThumbnails) {
                photoThumbnails.addEventListener('click', function(e) {
                    var img = e.target.closest('img');
                    if (img && img.dataset.photoIndex !== undefined) {
                        var index = parseInt(img.dataset.photoIndex, 10);
                        if (!isNaN(index)) {
                            setMainPhoto(index);
                        }
                    }
                });
            }
            
            // Initialize photo gallery
            if (photos.length > 0) {
                console.log('‚úì Initializing photo gallery with', photos.length, 'photos');
                // Show first photo automatically
                setMainPhoto(0);
                
                // Add keyboard navigation
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowLeft') {
                        changePhoto(-1);
                    } else if (e.key === 'ArrowRight') {
                        changePhoto(1);
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è No photos available to display');
            }
            
            // Initialize star ratings
            if (typeof initStarRatings === 'function') {
                initStarRatings();
            }
            
            // Initialize image upload
            if (typeof initImageUpload === 'function') {
                initImageUpload();
            }
            
            // Initialize review actions
            if (typeof initReviewActions === 'function') {
                initReviewActions();
            }
        }
        
        // Run initialization when DOM is ready
        // Wait a bit to ensure all functions are defined
        function safeInitialize() {
            try {
                console.log('Running safeInitialize...');
                initializeComponents();
                // Scroll to top after page loads
                window.scrollTo(0, 0);
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(safeInitialize, 100);
            });
        } else {
            setTimeout(safeInitialize, 100);
        }
        
        // Ensure page starts at top on load
        window.addEventListener('load', function() {
            window.scrollTo(0, 0);
        });
        
        // Prevent browser from restoring scroll position
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }

        // Define place coordinates once to avoid linter errors
        const placeLatitude = parseFloat('{{ lat|default:0|floatformat:6 }}') || 0;
        const placeLongitude = parseFloat('{{ lng|default:0|floatformat:6 }}') || 0;
        
        // Validate coordinates
        console.log('=== Coordinate Validation ===');
        console.log('Raw lat from server:', '{{ lat }}');
        console.log('Raw lng from server:', '{{ lng }}');
        console.log('Parsed placeLatitude:', placeLatitude);
        console.log('Parsed placeLongitude:', placeLongitude);
        
        if (placeLatitude === 0 && placeLongitude === 0) {
            console.error('‚ö†Ô∏è CRITICAL: Coordinates are (0, 0)!');
            console.error('  This means the place data was not loaded correctly.');
            console.error('  Maps will not display properly.');
        } else if (isNaN(placeLatitude) || isNaN(placeLongitude)) {
            console.error('‚ö†Ô∏è CRITICAL: Invalid coordinates!');
            console.error('  Latitude:', placeLatitude);
            console.error('  Longitude:', placeLongitude);
        } else {
            console.log('‚úì Valid coordinates:', placeLatitude, placeLongitude);
        }

        function showPhone() {
            document.querySelectorAll('.phone-masked').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.phone-full').forEach(el => el.style.display = 'inline');
            document.querySelectorAll('.btn-show-phone, .btn-show-phone-small').forEach(el => el.style.display = 'none');
        }

        // Map tabs
        document.querySelectorAll('.map-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                // If it's the directions tab, open Google Maps directly in a new window
                if (tabName === 'directions') {
                    const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${placeLatitude},${placeLongitude}`;
                    window.open(directionsUrl, '_blank');
                    return;
                }
                
                document.querySelectorAll('.map-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                document.getElementById('detail-map').style.display = tabName === 'map' ? 'block' : 'none';
                document.getElementById('street-view').style.display = tabName === 'streetview' ? 'block' : 'none';
                document.getElementById('directions-panel').style.display = tabName === 'directions' ? 'block' : 'none';
                
                if (tabName === 'streetview') {
                    // Small delay to ensure the element is visible before initializing
                    setTimeout(() => {
                        initStreetView();
                    }, 100);
                }
            });
        });
    </script>

    {% if GOOGLE_MAPS_API_KEY and not place.error and place.name %}
    <script>
        // Define callback FIRST before any conditional checks
        // This ensures the function exists when Google Maps loads
        window.initPlaceDetailMaps = function() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‚úì Google Maps API Callback Triggered');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            if (typeof google === 'undefined') {
                console.error('‚úó FATAL: google object is undefined!');
                if (typeof showMapErrors === 'function') showMapErrors();
                return;
            }
            
            if (!google.maps) {
                console.error('‚úó FATAL: google.maps is undefined!');
                if (typeof showMapErrors === 'function') showMapErrors();
                return;
            }
            
            if (!google.maps.Map) {
                console.error('‚úó FATAL: google.maps.Map is undefined!');
                if (typeof showMapErrors === 'function') showMapErrors();
                return;
            }
            
            console.log('‚úì All Google Maps API checks passed');
            console.log('  - google:', typeof google);
            console.log('  - google.maps:', typeof google.maps);
            console.log('  - google.maps.Map:', typeof google.maps.Map);
            console.log('  - google.maps.Marker:', typeof google.maps.Marker);
            
            // Check if coordinates are valid before initializing
            const lat = parseFloat('{{ lat|default:0 }}');
            const lng = parseFloat('{{ lng|default:0 }}');
            
            if (lat === 0 && lng === 0) {
                console.error('‚úó Cannot initialize maps: Invalid coordinates (0, 0)');
                alert('Error: Place location data is not available. The map cannot be displayed.');
                if (typeof showMapErrors === 'function') showMapErrors();
                return;
            }
            
            console.log('‚úì Coordinates validated:', lat, lng);
            console.log('‚úì Proceeding with map initialization...');
            console.log('');
            
            try {
                if (typeof initDetailMap === 'function') {
                    initDetailMap();
                    console.log('');
                }
                if (typeof initSidebarMap === 'function') {
                    initSidebarMap();
                    console.log('');
                }
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('‚úì ALL MAPS INITIALIZED SUCCESSFULLY ‚úì');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            } catch (error) {
                console.error('‚úó Error during map initialization:', error);
                console.error('  Stack trace:', error.stack);
                if (typeof showMapErrors === 'function') showMapErrors();
            }
        };
        
        {% if lat and lng %}
        // Only define map-specific functions if we have valid coordinates
        
        // Get category-based icon for marker with custom pin design
        function getCategoryIcon(types) {
            if (!types || types.length === 0) {
                return {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="50" viewBox="0 0 40 50">
                            <path d="M20 0C9 0 0 9 0 20c0 15 20 30 20 30s20-15 20-30C40 9 31 0 20 0z" fill="#4285F4"/>
                            <circle cx="20" cy="20" r="8" fill="white"/>
                            <text x="20" y="25" font-size="16" text-anchor="middle" fill="#4285F4">üìç</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 50),
                    anchor: new google.maps.Point(20, 50)
                };
            }
            
            // Category to icon mapping with colors and emoji icons
            const iconMap = {
                // Food & Drink
                'restaurant': { color: '#FF6B6B', emoji: 'üçΩÔ∏è', label: 'Restaurant' },
                'food': { color: '#FF6B6B', emoji: 'üçî', label: 'Food' },
                'cafe': { color: '#8B4513', emoji: '‚òï', label: 'Cafe' },
                'bar': { color: '#FFA500', emoji: 'üç∫', label: 'Bar' },
                'night_club': { color: '#FF1493', emoji: 'üéµ', label: 'Club' },
                'meal_takeaway': { color: '#FF8C00', emoji: 'ü•°', label: 'Takeaway' },
                'meal_delivery': { color: '#FF7043', emoji: 'üö¥', label: 'Delivery' },
                'bakery': { color: '#FF6F00', emoji: 'ü•ê', label: 'Bakery' },
                
                // Accommodation
                'lodging': { color: '#4ECDC4', emoji: 'üõèÔ∏è', label: 'Lodging' },
                'hotel': { color: '#4ECDC4', emoji: 'üè®', label: 'Hotel' },
                'motel': { color: '#26C6DA', emoji: 'üõèÔ∏è', label: 'Motel' },
                'hostel': { color: '#00ACC1', emoji: 'üè†', label: 'Hostel' },
                
                // Health
                'hospital': { color: '#E74C3C', emoji: 'üè•', label: 'Hospital' },
                'doctor': { color: '#E74C3C', emoji: '‚öïÔ∏è', label: 'Doctor' },
                'dentist': { color: '#EF5350', emoji: 'ü¶∑', label: 'Dentist' },
                'pharmacy': { color: '#DC143C', emoji: 'üíä', label: 'Pharmacy' },
                'physiotherapist': { color: '#EC407A', emoji: 'ü©∫', label: 'Physio' },
                'veterinary_care': { color: '#AB47BC', emoji: 'üêæ', label: 'Vet' },
                
                // Finance
                'bank': { color: '#2ECC71', emoji: 'üè¶', label: 'Bank' },
                'atm': { color: '#27AE60', emoji: 'üí∞', label: 'ATM' },
                'accounting': { color: '#66BB6A', emoji: 'üíµ', label: 'Accounting' },
                
                // Shopping
                'store': { color: '#9B59B6', emoji: 'üè™', label: 'Store' },
                'shopping_mall': { color: '#9B59B6', emoji: 'üõçÔ∏è', label: 'Mall' },
                'supermarket': { color: '#8E44AD', emoji: 'üõí', label: 'Supermarket' },
                'convenience_store': { color: '#BA68C8', emoji: 'üè™', label: 'Convenience' },
                'clothing_store': { color: '#CE93D8', emoji: 'üëï', label: 'Clothing' },
                'shoe_store': { color: '#E1BEE7', emoji: 'üëü', label: 'Shoes' },
                'jewelry_store': { color: '#F48FB1', emoji: 'üíé', label: 'Jewelry' },
                'book_store': { color: '#9575CD', emoji: 'üìö', label: 'Books' },
                'electronics_store': { color: '#7E57C2', emoji: 'üì±', label: 'Electronics' },
                'furniture_store': { color: '#9FA8DA', emoji: 'üõãÔ∏è', label: 'Furniture' },
                'home_goods_store': { color: '#B39DDB', emoji: 'üè†', label: 'Home' },
                'hardware_store': { color: '#7986CB', emoji: 'üîß', label: 'Hardware' },
                'department_store': { color: '#AB47BC', emoji: 'üè¨', label: 'Department' },
                
                // Education
                'school': { color: '#3498DB', emoji: 'üè´', label: 'School' },
                'university': { color: '#2980B9', emoji: 'üéì', label: 'University' },
                'primary_school': { color: '#42A5F5', emoji: 'üéí', label: 'Primary' },
                'secondary_school': { color: '#1E88E5', emoji: 'üìö', label: 'Secondary' },
                'library': { color: '#34495E', emoji: 'üìö', label: 'Library' },
                
                // Culture & Entertainment
                'museum': { color: '#95A5A6', emoji: 'üèõÔ∏è', label: 'Museum' },
                'art_gallery': { color: '#BDC3C7', emoji: 'üé®', label: 'Gallery' },
                'movie_theater': { color: '#5E35B1', emoji: 'üé¨', label: 'Cinema' },
                'stadium': { color: '#1E88E5', emoji: 'üèüÔ∏è', label: 'Stadium' },
                'zoo': { color: '#43A047', emoji: 'ü¶Å', label: 'Zoo' },
                'amusement_park': { color: '#AB47BC', emoji: 'üé¢', label: 'Park' },
                'aquarium': { color: '#00ACC1', emoji: 'üê†', label: 'Aquarium' },
                'casino': { color: '#F4511E', emoji: 'üé∞', label: 'Casino' },
                'bowling_alley': { color: '#FF7043', emoji: 'üé≥', label: 'Bowling' },
                
                // Recreation
                'park': { color: '#27AE60', emoji: 'üå≥', label: 'Park' },
                'gym': { color: '#E67E22', emoji: 'üí™', label: 'Gym' },
                'spa': { color: '#F39C12', emoji: 'üíÜ', label: 'Spa' },
                'tourist_attraction': { color: '#E91E63', emoji: '‚≠ê', label: 'Attraction' },
                'point_of_interest': { color: '#FF9800', emoji: 'üìå', label: 'POI' },
                'campground': { color: '#689F38', emoji: '‚õ∫', label: 'Camping' },
                
                // Transportation
                'airport': { color: '#1ABC9C', emoji: '‚úàÔ∏è', label: 'Airport' },
                'train_station': { color: '#16A085', emoji: 'üöÇ', label: 'Train' },
                'transit_station': { color: '#0097A7', emoji: 'üöâ', label: 'Transit' },
                'bus_station': { color: '#F39C12', emoji: 'üöå', label: 'Bus' },
                'subway_station': { color: '#D35400', emoji: 'üöá', label: 'Metro' },
                'light_rail_station': { color: '#00ACC1', emoji: 'üöä', label: 'Rail' },
                'gas_station': { color: '#E74C3C', emoji: '‚õΩ', label: 'Gas' },
                'parking': { color: '#7F8C8D', emoji: 'üÖøÔ∏è', label: 'Parking' },
                'car_rental': { color: '#95A5A6', emoji: 'üöó', label: 'Rental' },
                'car_wash': { color: '#26C6DA', emoji: 'üöø', label: 'Car Wash' },
                'car_repair': { color: '#78909C', emoji: 'üîß', label: 'Repair' },
                'taxi_stand': { color: '#FDD835', emoji: 'üöï', label: 'Taxi' },
                
                // Religion
                'church': { color: '#8E44AD', emoji: '‚õ™', label: 'Church' },
                'mosque': { color: '#2C3E50', emoji: 'üïå', label: 'Mosque' },
                'temple': { color: '#C0392B', emoji: 'üõï', label: 'Temple' },
                'hindu_temple': { color: '#E67E22', emoji: 'üïâÔ∏è', label: 'Temple' },
                'synagogue': { color: '#34495E', emoji: 'üïç', label: 'Synagogue' },
                'place_of_worship': { color: '#5D4037', emoji: 'üôè', label: 'Worship' },
                
                // Services
                'beauty_salon': { color: '#EC407A', emoji: 'üíÖ', label: 'Salon' },
                'hair_care': { color: '#D81B60', emoji: 'üíá', label: 'Hair' },
                'laundry': { color: '#5C6BC0', emoji: 'üß∫', label: 'Laundry' },
                'post_office': { color: '#FDD835', emoji: 'üìÆ', label: 'Post' },
                'real_estate_agency': { color: '#8D6E63', emoji: 'üèòÔ∏è', label: 'Real Estate' },
                'travel_agency': { color: '#26A69A', emoji: '‚úàÔ∏è', label: 'Travel' },
                'insurance_agency': { color: '#5C6BC0', emoji: 'üõ°Ô∏è', label: 'Insurance' },
                'lawyer': { color: '#455A64', emoji: '‚öñÔ∏è', label: 'Lawyer' },
                'locksmith': { color: '#78909C', emoji: 'üîë', label: 'Locksmith' },
                'moving_company': { color: '#FF7043', emoji: 'üì¶', label: 'Moving' },
                'plumber': { color: '#0288D1', emoji: 'üîß', label: 'Plumber' },
                'electrician': { color: '#FBC02D', emoji: '‚ö°', label: 'Electrician' },
                'roofing_contractor': { color: '#5D4037', emoji: 'üè†', label: 'Roofing' },
                'painter': { color: '#7CB342', emoji: 'üé®', label: 'Painter' },
                
                // Government & Public
                'police': { color: '#1565C0', emoji: 'üëÆ', label: 'Police' },
                'fire_station': { color: '#C62828', emoji: 'üöí', label: 'Fire' },
                'courthouse': { color: '#6A1B9A', emoji: '‚öñÔ∏è', label: 'Court' },
                'city_hall': { color: '#455A64', emoji: 'üèõÔ∏è', label: 'City Hall' },
                'local_government_office': { color: '#546E7A', emoji: 'üè¢', label: 'Gov Office' },
                'embassy': { color: '#1E88E5', emoji: 'üèõÔ∏è', label: 'Embassy' }
            };
            
            // Find matching category
            console.log('üîç Searching for icon match in types:', types);
            let iconData = null;
            
            // First try exact match
            for (let type of types) {
                if (iconMap[type]) {
                    iconData = iconMap[type];
                    console.log('‚úì EXACT MATCH found for type:', type, '‚Üí', iconData.emoji, iconData.label, iconData.color);
                    break;
                }
            }
            
            // If no exact match, try partial match
            if (!iconData) {
                console.log('‚ö†Ô∏è No exact match, trying partial match...');
                for (let type of types) {
                    for (let key in iconMap) {
                        if (type.includes(key) || key.includes(type)) {
                            iconData = iconMap[key];
                            console.log('‚úì PARTIAL MATCH found:', type, '~', key, '‚Üí', iconData.emoji, iconData.label, iconData.color);
                            break;
                        }
                    }
                    if (iconData) break;
                }
            }
            
            if (!iconData) {
                console.warn('‚úó No icon match found for types:', types);
                console.log('Available icon categories:', Object.keys(iconMap).slice(0, 10).join(', '), '...');
            }
            
            // Create custom SVG marker with icon
            if (iconData) {
                const svgIcon = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="45" height="55" viewBox="0 0 45 55">
                        <defs>
                            <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
                                <feOffset dx="0" dy="2" result="offsetblur"/>
                                <feComponentTransfer>
                                    <feFuncA type="linear" slope="0.3"/>
                                </feComponentTransfer>
                                <feMerge>
                                    <feMergeNode/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <g filter="url(#shadow)">
                            <path d="M22.5 0C10.1 0 0 10.1 0 22.5c0 16.9 22.5 32.5 22.5 32.5s22.5-15.6 22.5-32.5C45 10.1 34.9 0 22.5 0z" fill="${iconData.color}"/>
                            <circle cx="22.5" cy="22.5" r="11" fill="white" opacity="0.95"/>
                            <text x="22.5" y="30" font-size="18" text-anchor="middle" fill="${iconData.color}">${iconData.emoji}</text>
                        </g>
                    </svg>
                `;
                
                return {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svgIcon),
                    scaledSize: new google.maps.Size(45, 55),
                    anchor: new google.maps.Point(22.5, 55),
                    labelOrigin: new google.maps.Point(22.5, -5)
                };
            }
            
            // Default icon
            const defaultSvg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="50" viewBox="0 0 40 50">
                    <defs>
                        <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
                            <feOffset dx="0" dy="2" result="offsetblur"/>
                            <feComponentTransfer>
                                <feFuncA type="linear" slope="0.3"/>
                            </feComponentTransfer>
                            <feMerge>
                                <feMergeNode/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <g filter="url(#shadow)">
                        <path d="M20 0C9 0 0 9 0 20c0 15 20 30 20 30s20-15 20-30C40 9 31 0 20 0z" fill="#4285F4"/>
                        <circle cx="20" cy="20" r="9" fill="white" opacity="0.95"/>
                        <text x="20" y="27" font-size="16" text-anchor="middle" fill="#4285F4">üìç</text>
                    </g>
                </svg>
            `;
            
            return {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(defaultSvg),
                scaledSize: new google.maps.Size(40, 50),
                anchor: new google.maps.Point(20, 50)
            };
        }
        
        function createMarker(position, title, icon, mapInstance) {
            console.log('Creating marker with:');
            console.log('  - Position:', position);
            console.log('  - Title:', title);
            console.log('  - Place Types:', placeTypes);
            
            // Get category icon based on place types
            const markerIcon = icon || getCategoryIcon(placeTypes);
            console.log('  - Using icon:', markerIcon);
            
            // Use standard Marker API (more reliable than AdvancedMarkerElement)
            const markerOptions = {
                position: position,
                map: mapInstance,
                title: title,
                animation: google.maps.Animation.DROP,
                icon: markerIcon,
                optimized: false // Better for custom SVG icons
            };
            
            const marker = new google.maps.Marker(markerOptions);
            
            // Add click event to marker
            marker.addListener('click', function() {
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px; font-weight: 600;">
                                ${title}
                            </h3>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">
                                üìç ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}
                            </p>
                            ${placeTypes.length > 0 ? `
                                <p style="margin: 5px 0; color: #888; font-size: 13px;">
                                    üè∑Ô∏è ${placeTypes[0].replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                </p>
                            ` : ''}
                            <a href="#" onclick="window.scrollTo(0,0); return false;" 
                               style="display: inline-block; margin-top: 8px; color: #4285F4; text-decoration: none; font-size: 13px;">
                                View Details ‚Üë
                            </a>
                        </div>
                    `
                });
                infoWindow.open(mapInstance, marker);
            });
            
            // Make marker bounce on hover
            google.maps.event.addListener(marker, 'mouseover', function() {
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => marker.setAnimation(null), 750);
            });
            
            return marker;
        }
        
        function initDetailMap() {
            const detailMapElement = document.getElementById('detail-map');
            if (!detailMapElement) {
                console.error('Detail map element not found');
                return;
            }
            
            console.log('üó∫Ô∏è Initializing detail map...');
            console.log('  Coordinates:', placeLatitude, placeLongitude);
            console.log('  Element:', detailMapElement);
            
            try {
                // Hide error message and controls overlay
                const detailErrorDiv = detailMapElement.querySelector('.map-error');
                const detailControlsOverlay = detailMapElement.querySelector('.map-controls-overlay');
                
                if (detailErrorDiv) {
                    detailErrorDiv.style.display = 'none';
                    console.log('  ‚úì Error div hidden');
                }
                
                if (detailControlsOverlay) {
                    detailControlsOverlay.style.display = 'none';
                    console.log('  ‚úì Controls overlay hidden');
                }
                
                const detailCenter = { lat: placeLatitude, lng: placeLongitude };
                const detailMapOptions = {
                    zoom: 15,
                    center: detailCenter,
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true
                };
                
                const detailMap = new google.maps.Map(detailMapElement, detailMapOptions);
                console.log('  ‚úì Detail map created');
                
                const marker = createMarker(detailCenter, "{{ place.name|escapejs }}", null, detailMap);
                console.log('  ‚úì Detail marker created');
                
                console.log('‚úì Detail map initialized successfully!');
            } catch (error) {
                console.error('‚úó Error initializing detail map:', error);
                console.error('  Error details:', error.message);
                // Show error message
                const detailErrorDiv = detailMapElement.querySelector('.map-error');
                if (detailErrorDiv) {
                    detailErrorDiv.style.display = 'flex';
                }
            }
        }

        function initSidebarMap() {
            const sidebarMapElement = document.getElementById('sidebar-map');
            if (!sidebarMapElement) {
                console.error('‚úó Sidebar map element not found');
                return;
            }
            
            console.log('üó∫Ô∏è Initializing sidebar map...');
            console.log('  Coordinates:', placeLatitude, placeLongitude);
            console.log('  Element:', sidebarMapElement);
            
            try {
                // Hide error message and controls overlay
                const sidebarErrorDiv = sidebarMapElement.querySelector('.map-error');
                const sidebarControlsOverlay = sidebarMapElement.querySelector('.map-controls-overlay');
                
                if (sidebarErrorDiv) {
                    sidebarErrorDiv.style.display = 'none';
                    console.log('  ‚úì Error div hidden');
                }
                
                if (sidebarControlsOverlay) {
                    sidebarControlsOverlay.style.display = 'none';
                    console.log('  ‚úì Controls overlay hidden');
                }
                
                const sidebarCenter = { lat: placeLatitude, lng: placeLongitude };
                const sidebarMapOptions = {
                    zoom: 15,
                    center: sidebarCenter,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                    zoomControl: true
                };
                
                const sidebarMap = new google.maps.Map(sidebarMapElement, sidebarMapOptions);
                console.log('  ‚úì Sidebar map created');
                
                const marker = createMarker(sidebarCenter, "{{ place.name|escapejs }}", null, sidebarMap);
                console.log('  ‚úì Sidebar marker created');
                
                console.log('‚úì Sidebar map initialized successfully!');
            } catch (error) {
                console.error('‚úó Error initializing sidebar map:', error);
                console.error('  Error details:', error.message);
                // Show error message
                const sidebarErrorDiv = sidebarMapElement.querySelector('.map-error');
                if (sidebarErrorDiv) {
                    sidebarErrorDiv.style.display = 'flex';
                    const messageEl = sidebarErrorDiv.querySelector('.map-error-message');
                    if (messageEl) {
                        messageEl.innerHTML = 'Error: ' + error.message + '<br>Check console for details';
                    }
                }
            }
        }

        let streetViewPanorama = null;

        function initStreetView() {
            const streetViewElement = document.getElementById('street-view');
            if (!streetViewElement) {
                console.error('Street View element not found');
                return;
            }

            // Check if Google Maps API is loaded
            if (typeof google === 'undefined' || !google.maps || !google.maps.StreetViewPanorama) {
                console.error('Google Maps Street View API not loaded');
                showStreetViewError('Google Maps Street View API not available');
                return;
            }

            // Prevent multiple initializations
            if (streetViewPanorama) {
                return;
            }

            const streetViewCenter = { lat: placeLatitude, lng: placeLongitude };
            
            // Check if Street View is available for this location
            const streetViewService = new google.maps.StreetViewService();
            streetViewService.getPanorama({ location: streetViewCenter, radius: 50 }, function(data, status) {
                if (status === 'OK') {
                    // Street View is available, initialize panorama
                    streetViewPanorama = new google.maps.StreetViewPanorama(
                        streetViewElement,
                        {
                            position: streetViewCenter,
                            pov: { heading: 0, pitch: 0 },
                            zoom: 1,
                            visible: true
                        }
                    );
                    
                    // Hide error message if visible
                    const errorDiv = streetViewElement.querySelector('.map-error');
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                } else {
                    // Street View not available for this location
                    console.warn('Street View not available for this location:', status);
                    showStreetViewError('Street View is not available for this location. Try a different location or use the Map view instead.');
                }
            });
        }

        function showStreetViewError(message) {
            const streetViewElement = document.getElementById('street-view');
            if (!streetViewElement) return;
            
            const errorDiv = streetViewElement.querySelector('.map-error');
            if (errorDiv) {
                errorDiv.style.display = 'flex';
                const messageDiv = errorDiv.querySelector('.map-error-message');
                if (messageDiv && message) {
                    messageDiv.textContent = message;
                }
            }
        }

        function showMapErrors() {
            console.warn('Showing map error messages');
            const maps = ['detail-map', 'sidebar-map'];
            maps.forEach(mapId => {
                const mapElement = document.getElementById(mapId);
                if (mapElement) {
                    const errorDiv = mapElement.querySelector('.map-error');
                    if (errorDiv) {
                        errorDiv.style.display = 'flex';
                        // Update error message
                        const messageEl = errorDiv.querySelector('.map-error-message');
                        if (messageEl) {
                            messageEl.innerHTML = 'Unable to load Google Maps. Please check:<br>‚Ä¢ Internet connection<br>‚Ä¢ API key configuration<br>‚Ä¢ Browser console for details';
                        }
                        console.log('Error shown for', mapId);
                    }
                }
            });
        }

        // Handle Google Maps API errors
        window.gm_authFailure = function() {
            console.error('‚úó Google Maps authentication failed! Check your API key.');
            alert('Google Maps API Key Error: The API key is invalid, expired, or restricted. Please check the browser console for details.');
            showMapErrors();
        };

        // Try to initialize immediately if API is already loaded
        if (typeof google !== 'undefined' && google.maps && google.maps.Map) {
            console.log('‚úì Google Maps already loaded, initializing immediately');
            window.initPlaceDetailMaps();
        } else {
            console.log('‚è≥ Waiting for Google Maps API to load...');
            // Show error messages after timeout if API doesn't load
            setTimeout(function() {
                if (typeof google === 'undefined' || !google.maps) {
                    console.error('‚úó Google Maps API failed to load after 5 seconds');
                    console.log('Possible causes:');
                    console.log('1. Network connectivity issues');
                    console.log('2. Invalid or missing API key');
                    console.log('3. API key restrictions (HTTP referrers, IP addresses)');
                    console.log('4. Billing not enabled for the API key');
                    showMapErrors();
                }
            }, 5000);
        }
        {% endif %}
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initPlaceDetailMaps&loading=async" async defer></script>
    {% endif %}
    
    {% include 'components/auth_modals.html' %}
    
    <script src="{% static 'js/auth-checker.js' %}"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="{% static 'js/accessadvisr-script.js' %}"></script>
</body>
</html>
